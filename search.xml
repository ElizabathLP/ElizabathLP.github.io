<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ä¸€ä¸ªç®€å•çš„é¡µé¢åˆ†é¡µæ˜¾éšç®—æ³•</title>
      <link href="/posts/7a6cb371/"/>
      <url>/posts/7a6cb371/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¸€å¤©ï¼Œå‰ç«¯åŒå­¦æ‰¾æˆ‘ï¼Œè¯´é¡µé¢çš„åˆ†é¡µç»„ä»¶ç®—æ³•åº”è¯¥æ€ä¹ˆå†™ï¼Œä»–å·²ç»å†™æ‡µäº†ï¼Œå¹¶ä¸”æ‰¾äº† Element ç»„ä»¶çš„æºç æŸ¥çœ‹åˆ†é¡µç»„ä»¶ï¼Œå‘ç°Element åˆ†é¡µç»„ä»¶ç§»æ¤è¿‡æ¥æœ‰äº›é—®é¢˜ï¼Œè€Œä¸” Element åˆ†é¡µç»„ä»¶çš„ç®—æ³•å¾ˆçƒ‚ã€‚ç„¶åæˆ‘å°±å†™äº†ä¸€ä¸ªåˆ†é¡µç®—æ³•å‡ºæ¥</p><h1 id="å®ç°è¿‡ç¨‹"><a href="#å®ç°è¿‡ç¨‹" class="headerlink" title="å®ç°è¿‡ç¨‹"></a>å®ç°è¿‡ç¨‹</h1><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡è®¡ç®—å¼€å§‹æ¸²æŸ“å’Œç»“æŸæ¸²æŸ“çš„ç›’å­ä¸‹æ ‡ï¼Œç„¶åé™¤æœ€å°é¡µç å’Œæœ€å¤§é¡µç å¤–ï¼Œæ­¤å¤–çš„ï¼Œå‡ä¸è¿›è¡Œæ¸²æŸ“</p><h2 id="JavaScript-å®ç°æ–¹å¼"><a href="#JavaScript-å®ç°æ–¹å¼" class="headerlink" title="JavaScript å®ç°æ–¹å¼"></a>JavaScript å®ç°æ–¹å¼</h2><p>é„™äºº Js å­¦çš„å¾ˆçƒ‚ï¼Œæ±‚è½»å–·ã€‚ã€‚ã€‚ã€‚ğŸ˜€</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¸¸é‡ï¼šæ€»å…±é¡µé¢æ˜¾ç¤ºçš„ç›’å­æ•°</span></span><br><span class="line"><span class="keyword">var</span> SHOW_PAGE_NUM = <span class="number">9</span>;</span><br><span class="line"><span class="comment">// å¸¸é‡ï¼šå½“é€‰ä¸­ä¸­é—´é¡µç ï¼Œå‰åæ¸²æŸ“çš„ç›’å­æ•°é‡</span></span><br><span class="line"><span class="keyword">var</span> CENTER_AROUND_NUM = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// å½“å‰é¡µç </span></span><br><span class="line">    <span class="keyword">let</span> position = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// æ€»é¡µæ•°</span></span><br><span class="line">    <span class="keyword">let</span> pageCount = <span class="number">15</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// pageCount æ˜¯é¡µç æ€»æ•°ï¼Œposition æ˜¯å½“å‰é¡µç </span></span><br><span class="line">    process(pageCount, position);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params">pageCount, position</span>) </span>&#123;</span><br><span class="line">    position--;</span><br><span class="line">    <span class="keyword">let</span> pagesList = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. è®¡ç®—position å‰å¯æ”¾å‡ ä¸ªæ˜¾ç¤ºé¡µ</span></span><br><span class="line">    <span class="keyword">let</span> beforeSize = position - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. è®¡ç®—position åå¯æ”¾å‡ ä¸ªæ˜¾ç¤ºé¡µ</span></span><br><span class="line">    <span class="keyword">let</span> afterSize = pageCount - <span class="number">1</span> - <span class="number">1</span> - position;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. å½“ beforeSize &lt;= CENTER_AROUND_NUM æ—¶å‰è¾¹é¡µç æ¸²æŸ“</span></span><br><span class="line"><span class="comment">     * 2. å½“ afterSize &lt;= CENTER_AROUND_NUM æ—¶åè¾¹é¡µç æ¸²æŸ“</span></span><br><span class="line"><span class="comment">     * 3. å…¶ä»–æƒ…å†µ ä¸¤è¾¹æ¸²æŸ“</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å§‹æ¸²æŸ“çš„ç›’å­ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">let</span> startPosition;</span><br><span class="line">    <span class="comment">// æœ€åè¢«æ¸²æŸ“ç›’å­çš„ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">let</span> endPosition;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¡ç®—ä¸‹æ ‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (pageCount &lt;= SHOW_PAGE_NUM) &#123;</span><br><span class="line">        startPosition = <span class="number">0</span>;</span><br><span class="line">        endPosition = pageCount - <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (beforeSize &lt;= CENTER_AROUND_NUM) &#123;</span><br><span class="line">        startPosition = <span class="number">0</span>;</span><br><span class="line">        endPosition = CENTER_AROUND_NUM * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (afterSize &lt;= CENTER_AROUND_NUM) &#123;</span><br><span class="line">        startPosition = pageCount - <span class="number">1</span> - <span class="number">1</span> - CENTER_AROUND_NUM * <span class="number">2</span>;</span><br><span class="line">        endPosition = pageCount - <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        startPosition = position - <span class="number">3</span>;</span><br><span class="line">        endPosition = position + <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¸²æŸ“ç›’å­</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; pageCount; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> pg = &#123;&#125;;</span><br><span class="line">        pg.pagePosition = i + <span class="number">1</span>;</span><br><span class="line">        pg.isShow = (i == <span class="number">0</span> || i == pageCount - <span class="number">1</span> || i &gt;= startPosition &amp;&amp; i &lt;= endPosition);</span><br><span class="line">        pagesList.push(pg);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰“å°è¾“å‡º</span></span><br><span class="line">    <span class="built_in">console</span>.log(pagesList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Java-ä»£ç å®ç°æ–¹å¼"><a href="#Java-ä»£ç å®ç°æ–¹å¼" class="headerlink" title="Java ä»£ç å®ç°æ–¹å¼"></a>Java ä»£ç å®ç°æ–¹å¼</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.StringJoiner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHOW_PAGE_NUM = <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CENTER_AROUND_NUM = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> position = <span class="number">1</span>;</span><br><span class="line">        process(<span class="number">15</span>, position).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Pages&gt; <span class="title">process</span><span class="params">(<span class="keyword">int</span> pageCount, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è½¬æ¢ä¸ºä¸‹æ ‡</span></span><br><span class="line">        position--;</span><br><span class="line"></span><br><span class="line">        List&lt;Pages&gt; pagesList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. è®¡ç®—position å‰å¯æ”¾å‡ ä¸ªæ˜¾ç¤ºé¡µ</span></span><br><span class="line">        <span class="keyword">int</span> beforeSize = position - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. è®¡ç®—position åå¯æ”¾å‡ ä¸ªæ˜¾ç¤ºé¡µ</span></span><br><span class="line">        <span class="keyword">int</span> afterSize = pageCount - <span class="number">1</span> - <span class="number">1</span> - position;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 1. å½“ beforeSize &lt;= CENTER_AROUND_NUM æ—¶å‰è¾¹é¡µç æ¸²æŸ“</span></span><br><span class="line"><span class="comment">         * 2. å½“ afterSize &lt;= CENTER_AROUND_NUM æ—¶åè¾¹é¡µç æ¸²æŸ“</span></span><br><span class="line"><span class="comment">         * 3. å…¶ä»–æƒ…å†µ ä¸¤è¾¹æ¸²æŸ“</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> startPosition;</span><br><span class="line">        <span class="keyword">int</span> endPosition;</span><br><span class="line">        <span class="keyword">if</span> (pageCount &lt;= SHOW_PAGE_NUM) &#123;</span><br><span class="line">            startPosition = <span class="number">0</span>;</span><br><span class="line">            endPosition = pageCount - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (beforeSize &lt;= CENTER_AROUND_NUM) &#123;</span><br><span class="line">            startPosition = <span class="number">0</span>;</span><br><span class="line">            endPosition = CENTER_AROUND_NUM * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (afterSize &lt;= CENTER_AROUND_NUM) &#123;</span><br><span class="line">            startPosition = pageCount - <span class="number">1</span> - <span class="number">1</span> - CENTER_AROUND_NUM * <span class="number">2</span>;</span><br><span class="line">            endPosition = pageCount - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            startPosition = position - <span class="number">3</span>;</span><br><span class="line">            endPosition = position + <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pageCount; i++) &#123;</span><br><span class="line">            Pages pg = <span class="keyword">new</span> Pages();</span><br><span class="line">            pg.pagePosition = i + <span class="number">1</span>;</span><br><span class="line">            pg.isShow = (i == <span class="number">0</span> || i == pageCount - <span class="number">1</span> || i &gt;= startPosition &amp;&amp; i &lt;= endPosition);</span><br><span class="line">            pagesList.add(pg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pagesList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Pages</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> Integer pagePosition;</span><br><span class="line">        <span class="keyword">public</span> Boolean isShow;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            return new StringJoiner(", ", Pages.class.getSimpleName() + "[", "]")</span><br><span class="line">                    .add(<span class="string">"pagePosition="</span> + pagePosition)</span><br><span class="line">                    .add(<span class="string">"isShow="</span> + isShow)</span><br><span class="line">                    .toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> åˆ†é¡µ </tag>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HBase é›†ç¾¤å®‰è£…</title>
      <link href="/posts/34ad406f/"/>
      <url>/posts/34ad406f/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="Hbase-å®‰è£…"><a href="#Hbase-å®‰è£…" class="headerlink" title="Hbase å®‰è£…"></a>Hbase å®‰è£…</h1><p>ä»¥ä¸‰å°æœºå™¨æ­å»ºé›†ç¾¤ç¯å¢ƒä¸ºä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hbase1 10.10.3.129</span><br><span class="line"></span><br><span class="line">hbase2 10.10.3.130</span><br><span class="line"></span><br><span class="line">hbase3 10.10.3.131</span><br></pre></td></tr></table></figure><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><h3 id="åˆ›å»ºç›¸å…³ç”¨æˆ·"><a href="#åˆ›å»ºç›¸å…³ç”¨æˆ·" class="headerlink" title="åˆ›å»ºç›¸å…³ç”¨æˆ·"></a>åˆ›å»ºç›¸å…³ç”¨æˆ·</h3><blockquote><p>ä¸‰å°æœºå™¨æ“ä½œæ–¹å¼ç›¸åŒ</p></blockquote><p>åˆ›å»ºzookeeperã€Hbaseã€Hadoopç”¨æˆ·,å¹¶è®¾ç½®å¯†ç </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# useradd zookeeper</span><br><span class="line">[root@localhost opt]# passwd zookeeper</span><br><span class="line">[root@localhost opt]# useradd hadoop</span><br><span class="line">[root@localhost opt]# passwd hadoop</span><br><span class="line">[root@localhost opt]# useradd hbase</span><br><span class="line">[root@localhost opt]# passwd hbase</span><br></pre></td></tr></table></figure><p>å°†æ­¤ä¸‰ä¸ªç”¨æˆ·åŠ å…¥åˆ° sudoers ä¸­</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/sudoers</span><br></pre></td></tr></table></figure><h3 id="Hosts-ä¸-å…å¯†"><a href="#Hosts-ä¸-å…å¯†" class="headerlink" title="Hosts ä¸ å…å¯†"></a>Hosts ä¸ å…å¯†</h3><blockquote><p>ä¸‰å°æœºå™¨æ“ä½œæ–¹å¼ç›¸åŒ</p></blockquote><p>ç¼–è¾‘hosts</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# vim &#x2F;etc&#x2F;hosts</span><br></pre></td></tr></table></figure><p>åœ¨æ–‡ä»¶æœ«å°¾å¢åŠ ä»¥ä¸‹å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hbase1 10.10.3.129</span><br><span class="line">hbase2 10.10.3.130</span><br><span class="line">hbase3 10.10.3.131</span><br></pre></td></tr></table></figure><p>ç¼–è¾‘hostname</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# vim /etc/sysconfig/network</span><br></pre></td></tr></table></figure><p>å¡«å…¥ä»¥ä¸‹å†…å®¹(æ ¹æ®ç›¸åº”IPå¯¹åº”å…³ç³»ï¼Œåœ¨ç›¸åº”hostsä¸Šé…ç½®)</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">HOSTNAME</span>=<span class="string">hbase1</span></span><br></pre></td></tr></table></figure><p>å…å¯†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ssh-keygen</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:F142fovQQib0Kgl/WL/USKPv8z/8Xfb0O5/dD/wA+Fo root@localhost.localdomain</span><br><span class="line">The key's randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|        .        |</span><br><span class="line">|       . .       |</span><br><span class="line">|    .   o B +    |</span><br><span class="line">|     o + X @ .   |</span><br><span class="line">|      = S X = .  |</span><br><span class="line">|       o + = = . |</span><br><span class="line">|          o E.= +|</span><br><span class="line">|         ..o  oBO|</span><br><span class="line">|          oo...=/|</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ssh-copy-id hbase1</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_rsa.pub"</span><br><span class="line">The authenticity of host 'hbase1 (10.10.3.129)' can't be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:GkgGCNlxc55obBDytcgmvK5kJXR5wHuhKejQwr/yxfg.</span><br><span class="line">ECDSA key fingerprint is MD5:1f:70:01:4a:06:a8:66:e7:88:47:bf:4c:0f:30:5b:52.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span><br><span class="line">root@hbase1's password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   "ssh 'hbase1'"</span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ssh-copy-id hbase2</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_rsa.pub"</span><br><span class="line">The authenticity of host 'hbase2 (10.10.3.130)' can't be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:GkgGCNlxc55obBDytcgmvK5kJXR5wHuhKejQwr/yxfg.</span><br><span class="line">ECDSA key fingerprint is MD5:1f:70:01:4a:06:a8:66:e7:88:47:bf:4c:0f:30:5b:52.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span><br><span class="line">root@hbase2's password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   "ssh 'hbase2'"</span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ssh-copy-id hbase3</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_rsa.pub"</span><br><span class="line">The authenticity of host 'hbase3 (10.10.3.131)' can't be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:GkgGCNlxc55obBDytcgmvK5kJXR5wHuhKejQwr/yxfg.</span><br><span class="line">ECDSA key fingerprint is MD5:1f:70:01:4a:06:a8:66:e7:88:47:bf:4c:0f:30:5b:52.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span><br><span class="line">root@hbase3's password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   "ssh 'hbase3'"</span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br></pre></td></tr></table></figure><p>åˆ†åˆ«åˆ‡æ¢åˆ°hadoopç”¨æˆ·ï¼Œæ‰§è¡Œä¸Šæ–¹å…å¯†æ“ä½œï¼Œæ–¹å¼ç›¸åŒ</p><h3 id="å…³é—­é˜²ç«å¢™"><a href="#å…³é—­é˜²ç«å¢™" class="headerlink" title="å…³é—­é˜²ç«å¢™"></a>å…³é—­é˜²ç«å¢™</h3><blockquote><p>ä¸‰å°æœºå™¨æ“ä½œæ–¹å¼ç›¸åŒ</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl stop firewalld</span><br><span class="line">[root@localhost ~]# systemctl disable firewalld</span><br></pre></td></tr></table></figure><h3 id="JDK-1-8"><a href="#JDK-1-8" class="headerlink" title="JDK 1.8"></a>JDK 1.8</h3><blockquote><p>ä¸‰å°æœºå™¨æ“ä½œæ–¹å¼ç›¸åŒ</p></blockquote><p>ä¸‹è½½ JDK1.8 å®‰è£…åŒ…</p><p>æ”¾ç½®åˆ° <code>/opt</code> ä¸‹å¹¶è§£å‹</p><p>é‡å‘½åæ–‡ä»¶å¤¹ä¸º <code>jdk</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# tar -zxvf jdk-8u251-linux-x64.tar.gz</span><br><span class="line">[root@localhost opt]# mv /opt/jdk1.8.0_251 /opt/jdk</span><br></pre></td></tr></table></figure><p>é…ç½®ç¯å¢ƒå˜é‡</p><p>ç¼–è¾‘ <code>/etc/profile</code></p><p>åœ¨æ–‡ä»¶æœ«å°¾å¢åŠ ä¸¤è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> jdk ç›¸å…³</span></span><br><span class="line">export JAVA_HOME=/opt/jdk</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br></pre></td></tr></table></figure><p>åŠ è½½æ–°é…ç½®çš„ç¯å¢ƒå˜é‡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# source /etc/profile</span><br></pre></td></tr></table></figure><h3 id="é‡å¯æœºå™¨"><a href="#é‡å¯æœºå™¨" class="headerlink" title="é‡å¯æœºå™¨"></a>é‡å¯æœºå™¨</h3><blockquote><p>ä¸‰å°æœºå™¨æ“ä½œæ–¹å¼ç›¸åŒ</p></blockquote><h2 id="å®‰è£…-Zookeeper"><a href="#å®‰è£…-Zookeeper" class="headerlink" title="å®‰è£… Zookeeper"></a>å®‰è£… Zookeeper</h2><blockquote><p>ä¸‰å°æœºå™¨æ“ä½œæ–¹å¼ç›¸åŒ</p></blockquote><p>ä¸‹è½½ Zookeeper å®‰è£…åŒ…</p><p>æ”¾ç½®åˆ° <code>/opt</code> ä¸‹å¹¶è§£å‹</p><p>é‡å‘½åæ–‡ä»¶å¤¹ä¸º <code>zookeeper</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# tar -zxvf apache-zookeeper-3.5.7-bin.tar.gz</span><br><span class="line">[root@localhost opt]# mv /opt/apache-zookeeper-3.5.7-bin /opt/zookeeper</span><br></pre></td></tr></table></figure><p>é…ç½®ç¯å¢ƒå˜é‡</p><p>ç¼–è¾‘ <code>/etc/profile</code></p><p>åœ¨æ–‡ä»¶æœ«å°¾å¢åŠ </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> zookeeperç›¸å…³</span></span><br><span class="line">export ZOOKEEPER_HOME=/opt/zookeeper</span><br></pre></td></tr></table></figure><p>åŠ è½½æ–°é…ç½®çš„ç¯å¢ƒå˜é‡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# source /etc/profile</span><br></pre></td></tr></table></figure><p>åˆ›å»ºæ•°æ®å­˜æ”¾è·¯å¾„ï¼Œæ—¥å¿—å­˜æ”¾è·¯å¾„ï¼Œåˆ›å»ºzookeeper IDæ–‡ä»¶ï¼Œå¹¶èµ‹æƒã€‚å…¶ä¸­ <code>your id</code>ä¸ºä½ çš„zookeeperèŠ‚ç‚¹IDï¼Œéœ€ä¿è¯ä¸‰å°ä¸é‡å¤ï¼Œä¸”ä¸ºæ•°å­—</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# mkdir -p /data/zookeeper</span><br><span class="line">[root@localhost opt]# mkdir -p /var/log/zookeeper</span><br><span class="line">[root@localhost opt]# echo "your id" &gt; /data/zookeeper/myid</span><br><span class="line">[root@localhost opt]# chown -R zookeeper:zookeeper /data/zookeeper</span><br><span class="line">[root@localhost opt]# chown -R zookeeper:zookeeper /var/log/zookeeper</span><br><span class="line">[root@localhost opt]# chown -R zookeeper:zookeeper /opt/zookeeper</span><br></pre></td></tr></table></figure><p>åˆ›å»º zookeeper é…ç½®æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# cp $ZOOKEEPER_HOME/conf/zoo_sample.cfg $ZOOKEEPER_HOME/conf/zoo.cfg</span><br></pre></td></tr></table></figure><p>ç¼–è¾‘ zookeeper é…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹ <code>dataDir</code> å‚æ•°</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataDir</span>=<span class="string">/data/zookeeper</span></span><br></pre></td></tr></table></figure><p>ç¼–è¾‘ zookeeper é…ç½®æ–‡ä»¶ï¼Œå¢åŠ ä»¥ä¸‹å‚æ•°(server.id ä¸ºä½ ä¸Šæ–¹çš„ zookeeper èŠ‚ç‚¹ID)</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.1</span>=<span class="string">hbase1:2888:3888</span></span><br><span class="line"><span class="meta">server.2</span>=<span class="string">hbase2:2888:3888</span></span><br><span class="line"><span class="meta">server.3</span>=<span class="string">hbase3:2888:3888</span></span><br></pre></td></tr></table></figure><h2 id="å®‰è£…-Hadoop"><a href="#å®‰è£…-Hadoop" class="headerlink" title="å®‰è£… Hadoop"></a>å®‰è£… Hadoop</h2><blockquote><p>æ­¤æ“ä½œä¸‰å°ç›¸åŒï¼Œä¸‰å°æ˜¯ç›¸åŒçš„é…ç½®æ–‡ä»¶</p></blockquote><p>ä¸‹è½½ Hadoop å®‰è£…åŒ…</p><p>æ”¾ç½®åˆ° <code>/opt</code> ä¸‹å¹¶è§£å‹</p><p>é‡å‘½åæ–‡ä»¶å¤¹ä¸º <code>hadoop</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# tar -zxvf hadoop-2.8.1.tar.gz</span><br><span class="line">[root@localhost opt]# mv /opt/hadoop-2.8.1 /opt/hadoop</span><br></pre></td></tr></table></figure><p>é…ç½®ç¯å¢ƒå˜é‡</p><p>ç¼–è¾‘ <code>/etc/profile</code></p><p>åœ¨æ–‡ä»¶æœ«å°¾å¢åŠ </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> hadoop ç›¸å…³</span></span><br><span class="line">export HADOOP_HOME=/opt/hadoop</span><br><span class="line">export HADOOP_PREFIX=$HADOOP_HOME</span><br><span class="line">export HADOOP_MAPRED_HOME=$HADOOP_HOME</span><br><span class="line">export HADOOP_COMMON_HOME=$HADOOP_HOME</span><br><span class="line">export HADOOP_HDFS_HOME=$HADOOP_HOME</span><br><span class="line">export YARN_HOME=$HADOOP_HOME</span><br><span class="line">export HADOOP_COMMON_LIB_NATIVE_DIR=$HADOOP_HOME/lib/native</span><br><span class="line">export PATH=$PATH:$HADOOP_HOME/sbin:$HADOOP_HOME/bin</span><br><span class="line">export HADOOP_INSTALL=$HADOOP_HOME</span><br></pre></td></tr></table></figure><p>åŠ è½½æ–°é…ç½®çš„ç¯å¢ƒå˜é‡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# source /etc/profile</span><br></pre></td></tr></table></figure><h4 id="ç¼–è¾‘-Hadoop-ç›¸å…³é…ç½®æ–‡ä»¶"><a href="#ç¼–è¾‘-Hadoop-ç›¸å…³é…ç½®æ–‡ä»¶" class="headerlink" title="ç¼–è¾‘ Hadoop ç›¸å…³é…ç½®æ–‡ä»¶"></a>ç¼–è¾‘ Hadoop ç›¸å…³é…ç½®æ–‡ä»¶</h4><h5 id="slaves"><a href="#slaves" class="headerlink" title="slaves"></a>slaves</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim $HADOOP_HOME/etc/hadoop/slaves</span><br></pre></td></tr></table></figure><p>å¡«å…¥ ip ä¸hostsçš„æ˜ å°„å…³ç³»</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hbase1 10.10.3.129</span><br><span class="line">hbase2 10.10.3.130</span><br><span class="line">hbase3 10.10.3.131</span><br></pre></td></tr></table></figure><h5 id="hdfs-site-xml"><a href="#hdfs-site-xml" class="headerlink" title="hdfs-site.xml"></a>hdfs-site.xml</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim $HADOOP_HOME/etc/hadoop/hdfs-site.xml</span><br></pre></td></tr></table></figure><p>å®Œæ•´é…ç½®æ–‡ä»¶å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment">  you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">  distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">  See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">  limitations under the License. See accompanying LICENSE file.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Put site-specific property overrides in this file. --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.nameservices<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>mycluster<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.ha.namenodes.mycluster<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hbase1,hbase2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.rpc-address.mycluster.hbase1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hbase1:8020<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.http-address.mycluster.hbase1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hbase1:50070<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.rpc-address.mycluster.hbase2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hbase2:8020<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.http-address.mycluster.hbase2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hbase2:50070<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.shared.edits.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>qjournal://hbase1:8485;hbase2:8485;hbase3:8485/mycluster<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.client.failover.proxy.provider.mycluster<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.ha.fencing.methods<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>sshfence<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.ha.fencing.ssh.private-key-files<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/home/hadoop/.ssh/id_rsa<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.name.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>file:///data/hadoop/hdfs/namenode<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.datanode.name.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>file:///data/hadoop/hdfs/datanode<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.journalnode.edits.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/data/hadoop/hdfs/journalnode<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.qjournal.start-segment.timeout.ms<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>60000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.ha.automatic-failover.enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>ha.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hbase1:2181,hbase2:2181,hbase3:2181<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="core-site-xml"><a href="#core-site-xml" class="headerlink" title="core-site.xml"></a>core-site.xml</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim $HADOOP_HOME/etc/hadoop/core-site.xml</span><br></pre></td></tr></table></figure><p>å®Œæ•´é…ç½®æ–‡ä»¶å¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment">  you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">  distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">  See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">  limitations under the License. See accompanying LICENSE file.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Put site-specific property overrides in this file. --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://mycluster<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>ha.zookeeper.session-timeout.ms<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>30000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="hadoop-env-sh"><a href="#hadoop-env-sh" class="headerlink" title="hadoop-env.sh"></a>hadoop-env.sh</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim $HADOOP_HOME/etc/hadoop/hadoop-env.sh</span><br></pre></td></tr></table></figure><p>åœ¨æ–‡ä»¶å¤´éƒ¨å¡«å…¥ä»¥ä¸‹å†…å®¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export HADOOP_NAMENODE_OPTS=" -Xms1024m -Xmx1024m -XX:+UseParallelGC"</span><br><span class="line">export HADOOP_DATANODE_OPTS=" -Xms1024m -Xmx1024m"</span><br><span class="line">export HADOOP_LOG_DIR=/var/log/hadoop</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºç›¸å…³æ–‡ä»¶å¤¹"><a href="#åˆ›å»ºç›¸å…³æ–‡ä»¶å¤¹" class="headerlink" title="åˆ›å»ºç›¸å…³æ–‡ä»¶å¤¹"></a>åˆ›å»ºç›¸å…³æ–‡ä»¶å¤¹</h4><p>åˆ›å»ºæ•°æ®å­˜æ”¾è·¯å¾„ï¼Œæ—¥å¿—å­˜æ”¾è·¯å¾„ï¼Œå¹¶èµ‹æƒã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# mkdir -p /data/hadoop/hdfs</span><br><span class="line">[root@localhost opt]# mkdir -p /data/hadoop/hdfs/journalnode</span><br><span class="line">[root@localhost opt]# mkdir -p /var/log/hadoop</span><br><span class="line">[root@localhost opt]# chown -R hadoop:hadoop /data/hadoop</span><br><span class="line">[root@localhost opt]# chown -R hadoop:hadoop /var/log/hadoop</span><br><span class="line">[root@localhost opt]# chown -R hadoop:hadoop /opt/hadoop</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…HBase"><a href="#å®‰è£…HBase" class="headerlink" title="å®‰è£…HBase"></a>å®‰è£…HBase</h2><blockquote><p>æ­¤æ“ä½œä¸‰å°ç›¸åŒï¼Œä¸‰å°æ˜¯ç›¸åŒçš„é…ç½®æ–‡ä»¶</p></blockquote><p>ä¸‹è½½ HBaseå®‰è£…åŒ…</p><p>æ”¾ç½®åˆ° <code>/opt</code> ä¸‹å¹¶è§£å‹</p><p>é‡å‘½åæ–‡ä»¶å¤¹ä¸º <code>hbase</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# tar -zxvf hbase-2.3.0-bin.tar.gz</span><br><span class="line">[root@localhost opt]# mv /opt/hbase-2.3.0 /opt/hbase</span><br></pre></td></tr></table></figure><p>é…ç½®ç¯å¢ƒå˜é‡</p><p>ç¼–è¾‘ <code>/etc/profile</code></p><p>åœ¨æ–‡ä»¶æœ«å°¾å¢åŠ </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> hbaseç›¸å…³</span></span><br><span class="line">export HBASE_HOME=/opt/hbase</span><br><span class="line">export PATH=$PATH:$HBASE_HOME/bin</span><br></pre></td></tr></table></figure><p>åŠ è½½æ–°é…ç½®çš„ç¯å¢ƒå˜é‡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# source /etc/profile</span><br></pre></td></tr></table></figure><h4 id="ç¼–è¾‘ç›¸å…³é…ç½®æ–‡ä»¶"><a href="#ç¼–è¾‘ç›¸å…³é…ç½®æ–‡ä»¶" class="headerlink" title="ç¼–è¾‘ç›¸å…³é…ç½®æ–‡ä»¶"></a>ç¼–è¾‘ç›¸å…³é…ç½®æ–‡ä»¶</h4><h5 id="hdfs-site-xml-1"><a href="#hdfs-site-xml-1" class="headerlink" title="hdfs-site.xml"></a>hdfs-site.xml</h5><p>å°†hadoopä¸‹çš„hdfs-xite.xml å¤åˆ¶æˆ–è½¯é“¾æ¥ä¸€ä»½åˆ°  <code>$HBASE_HOME/conf</code> ä¸‹ã€‚è¿™é‡Œå»ºè®®è½¯è¿æ¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# ln -s /opt/hadoop/etc/hadoop/hdfs-site.xml /opt/hbase/conf/hdfs-site.xml</span><br></pre></td></tr></table></figure><h5 id="hbase-site-xml"><a href="#hbase-site-xml" class="headerlink" title="hbase-site.xml"></a>hbase-site.xml</h5><p>åœ¨åŸæ–‡ä»¶ä¸­å¢åŠ å¦‚ä¸‹å†…å®¹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://mycluster/hbase<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.property.dataDir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>/data/hbase/zookeeper<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>hbase1,hbase2,hbase3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="hbase-env-sh"><a href="#hbase-env-sh" class="headerlink" title="hbase-env.sh"></a>hbase-env.sh</h5><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­ <code>HBASE_CLASSPATH</code> å†…å®¹ï¼Œå¦‚æœ‰æ³¨é‡Šï¼Œè¯·å…ˆå–æ¶ˆæ³¨é‡Š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export HBASE_CLASSPATH=/opt/hadoop/etc/hadoop</span><br><span class="line">export HBASE_LOG_DIR=/var/log/hbase</span><br><span class="line">export HBASE_MANAGES_ZK=false</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºç›¸å…³æ–‡ä»¶å¤¹-1"><a href="#åˆ›å»ºç›¸å…³æ–‡ä»¶å¤¹-1" class="headerlink" title="åˆ›å»ºç›¸å…³æ–‡ä»¶å¤¹"></a>åˆ›å»ºç›¸å…³æ–‡ä»¶å¤¹</h4><p>åˆ›å»ºæ•°æ®å­˜æ”¾è·¯å¾„ï¼Œæ—¥å¿—å­˜æ”¾è·¯å¾„ï¼Œå¹¶èµ‹æƒã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# mkdir -p /data/hbase</span><br><span class="line">[root@localhost opt]# mkdir -p /data/hbase/zookeeper</span><br><span class="line">[root@localhost opt]# mkdir -p /var/log/hbase</span><br><span class="line">[root@localhost opt]# chown -R hbase:hbase /data/hbase</span><br><span class="line">[root@localhost opt]# chown -R hbase:hbase /var/log/hbase</span><br><span class="line">[root@localhost opt]# chown -R hbase:hbase /opt/hbase</span><br></pre></td></tr></table></figure><h2 id="åˆå§‹åŒ–-Zookeeper"><a href="#åˆå§‹åŒ–-Zookeeper" class="headerlink" title="åˆå§‹åŒ– Zookeeper"></a>åˆå§‹åŒ– Zookeeper</h2><blockquote><p>æ­¤æ“ä½œä¸‰å°ç›¸åŒ</p><p>å¯åŠ¨å‰è¯·æ³¨æ„å…³é—­é˜²ç«å¢™</p></blockquote><p>åˆ‡æ¢åˆ° zookeeper ç”¨æˆ·</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# su - zookeeper</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ Zookeeper æœåŠ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[zookeeper@localhost ~]# $ZOOKEEPER_HOME/bin/zkServer.sh start</span><br></pre></td></tr></table></figure><p>ç„¶åæŸ¥çœ‹Zookeeperé›†ç¾¤çŠ¶æ€</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[zookeeper@localhost ~]# $ZOOKEEPER_HOME/bin/zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /opt/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost.</span><br><span class="line">Mode: leader</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿”å›ä¿¡æ¯ï¼Œå¦‚æœé›†ç¾¤ä¸­æ˜¾ç¤ºæœ‰ä¸¤ä¸ª <code>follower</code> å’Œä¸€ä¸ª <code>leader</code> ï¼Œè¯´æ˜é›†ç¾¤å¯åŠ¨æˆåŠŸ</p><h2 id="åˆå§‹åŒ–HDFS"><a href="#åˆå§‹åŒ–HDFS" class="headerlink" title="åˆå§‹åŒ–HDFS"></a>åˆå§‹åŒ–HDFS</h2><blockquote><p>ä¸‰å°æœºå™¨æ“ä½œç›¸åŒ</p></blockquote><p>åˆ‡æ¢åˆ° hadoop ç”¨æˆ·</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# su - hadoop</span><br></pre></td></tr></table></figure><h3 id="1-å¯åŠ¨-journalnode-æœåŠ¡"><a href="#1-å¯åŠ¨-journalnode-æœåŠ¡" class="headerlink" title="1. å¯åŠ¨ journalnode æœåŠ¡"></a>1. å¯åŠ¨ journalnode æœåŠ¡</h3><blockquote><p>ä¸‰å°æœºå™¨æ“ä½œç›¸åŒ</p></blockquote><p>å¯åŠ¨ journalnode æœåŠ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@localhost ~]# $HADOOP_HOME/sbin/hadoop-daemon.sh start journalnode</span><br></pre></td></tr></table></figure><p>ç„¶åæŸ¥çœ‹ç›¸å…³è¿›ç¨‹ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@localhost ~]# jps</span><br><span class="line">2410 Jps</span><br><span class="line">15231 JournalNode</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿”å›ä¿¡æ¯ï¼Œå¦‚æœæ˜¾ç¤ºäº† <code>JournalNode</code> è¿›ç¨‹ï¼Œä¸”æŸ¥çœ‹æ—¥å¿—æ²¡æœ‰å‘ç°ç›¸å…³é”™è¯¯ä¿¡æ¯ï¼Œè¯´æ˜ <code>JournalNode</code> å¯åŠ¨æˆåŠŸ</p><p>æŸ¥çœ‹ <code>JournalNode</code>  æ—¥å¿—ä¿¡æ¯(åè¾¹çš„ <code>hbase1</code> æ˜¯ä½ çš„ä¸»æœºåç§°ï¼Œå…¶ä»–ä¸¤å°æ ¹æ®å®é™…æƒ…å†µæ›´æ¢ä¸»æœºåå³å¯)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@localhost ~]# /var/log/hadoop/hadoop-hadoop-journalnode-hbase1.log</span><br></pre></td></tr></table></figure><h3 id="2-åˆå§‹åŒ–-Namenode"><a href="#2-åˆå§‹åŒ–-Namenode" class="headerlink" title="2. åˆå§‹åŒ– Namenode"></a>2. åˆå§‹åŒ– Namenode</h3><p>åœ¨ç¬¬ä¸€å°æœºå™¨ä¸Šï¼Œä¹Ÿå°±æ˜¯ <code>hbase1</code> ä¸Šï¼Œæ‰§è¡Œä»¥ä¸‹ä»£ç è¿›è¡Œåˆå§‹åŒ–</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åˆå§‹åŒ–ä¸»namenode</span></span><br><span class="line">[hadoop@hbase1 ~]# hdfs namenode -format</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰ç›¸å…³é”™è¯¯ä¿¡æ¯ï¼Œä¸”åˆå§‹åŒ–æˆåŠŸç»“æŸï¼Œè¯´æ˜ä¸» <code>namenode</code> åˆå§‹åŒ–æˆåŠŸ</p><p>ç„¶åå¯åŠ¨åˆšåˆå§‹åŒ–çš„ <code>namenode</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1 ~]# $HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs start namenode</span><br></pre></td></tr></table></figure><p>åœ¨ç¬¬äºŒå°æœºå™¨ä¸Šï¼Œä¹Ÿå°±æ˜¯ <code>hbase2</code> ä¸Šï¼Œæ‰§è¡Œä»¥ä¸‹ä»£ç è¿›è¡Œåˆå§‹åŒ–</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åˆå§‹åŒ–å¤‡namenode</span></span><br><span class="line">[hadoop@hbase2 ~]# hdfs namenode -bootstrapStandby</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å…³é—­ç¬¬ä¸€å°åˆšå¯åŠ¨çš„ <code>namenode</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1 ~]# $HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs stop namenode</span><br></pre></td></tr></table></figure><p>ç„¶ååˆå§‹åŒ– <code>JournalNode</code>  ä¸­çš„è®°å½•ï¼Œåœ¨ç¬¬ä¸€å° <code>namenode</code> ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1 ~]# hdfs namenode -initializeSharedEdits</span><br></pre></td></tr></table></figure><p>å¯åŠ¨åˆšåˆå§‹åŒ–å¥½çš„ä¸¤å° <code>namenode</code>  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1(hbase2) ~]# $HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs start namenode</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ä¸¤å°<code>namenode</code>åˆ†åˆ«æŸ¥çœ‹ç›¸å…³è¿›ç¨‹ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1 ~]$ jps</span><br><span class="line">15792 NameNode</span><br><span class="line">2648 Jps</span><br><span class="line">15231 JournalNode</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿”å›ä¿¡æ¯ï¼Œå¦‚æœæ˜¾ç¤ºäº† <code>namenode</code>  è¿›ç¨‹ï¼Œä¸”æŸ¥çœ‹æ—¥å¿—æ²¡æœ‰å‘ç°ç›¸å…³é”™è¯¯ä¿¡æ¯ï¼Œè¯´æ˜ <code>namenode</code>  å¯åŠ¨æˆåŠŸ</p><p>æŸ¥çœ‹ <code>namenode</code>  æ—¥å¿—ä¿¡æ¯(åè¾¹çš„ <code>hbase1</code> æ˜¯ä½ çš„ä¸»æœºåç§°ï¼Œå…¶ä»–ä¸¤å°æ ¹æ®å®é™…æƒ…å†µæ›´æ¢ä¸»æœºåå³å¯)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1 ~]# /var/log/hadoop/hadoop-hadoop-namenode-hbase1.log</span><br></pre></td></tr></table></figure><h3 id="3-åˆå§‹åŒ–-zkfc"><a href="#3-åˆå§‹åŒ–-zkfc" class="headerlink" title="3. åˆå§‹åŒ– zkfc"></a>3. åˆå§‹åŒ– zkfc</h3><p>åœ¨ç¬¬ä¸€å°æœºå™¨ä¸Šï¼Œä¹Ÿå°±æ˜¯ <code>hbase1</code> ä¸Šï¼Œæ‰§è¡Œä»¥ä¸‹ä»£ç è¿›è¡Œåˆå§‹åŒ–</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åˆå§‹åŒ–zkfc</span></span><br><span class="line">[hadoop@hbase1 ~]# hdfs zkfc -formatZK</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰ç›¸å…³é”™è¯¯ä¿¡æ¯ï¼Œä¸”åˆå§‹åŒ–æˆåŠŸç»“æŸï¼ŒæŸ¥çœ‹ <code>zookeeper</code> ä¸­ç›¸å…³ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹zookeeperä¸­ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">[hadoop@hbase1 ~]# $ZOOKEEPER_HOME/bin/zkCli.sh</span><br><span class="line">Connecting to localhost:2181</span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] ls /</span><br><span class="line">[hadoop-ha, zookeeper]</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¤šå‡ºäº†ä¸€ä¸ª <code>hadoop-ha</code> ç›®å½•ï¼Œè¯´æ˜åˆå§‹åŒ–æ­£ç¡®</p><p>æ¥ä¸‹æ¥åœæ­¢ä¸¤å° <code>namenode</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1(hbase2) ~]# $HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs stop namenode</span><br></pre></td></tr></table></figure><p>ç„¶åå¯åŠ¨ä¸¤å° <code>namenode</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1(hbase2) ~]# $HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs start namenode</span><br></pre></td></tr></table></figure><p>é€šè¿‡æµè§ˆå™¨è®¿é—® <code>&lt;hostname&gt;:50070</code> å¯ä»¥çœ‹åˆ°ä¸¤å° <code>namenode</code> ç°åœ¨éƒ½å¤„äº <code>standby</code> çŠ¶æ€</p><p>ä¸¤å°å¯åŠ¨ <code>zkfc</code> </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1(hbase2) ~]# $HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs start zkfc</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ä¸¤å°<code>namenode</code>åˆ†åˆ«æŸ¥çœ‹ç›¸å…³è¿›ç¨‹ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1 ~]$ jps</span><br><span class="line">15792 NameNode</span><br><span class="line">15908 DFSZKFailoverController</span><br><span class="line">5339 Jps</span><br><span class="line">15231 JournalNode</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿”å›ä¿¡æ¯ï¼Œå¦‚æœæ˜¾ç¤ºäº† <code>DFSZKFailoverController</code>  è¿›ç¨‹ï¼Œä¸”æŸ¥çœ‹æ—¥å¿—æ²¡æœ‰å‘ç°ç›¸å…³é”™è¯¯ä¿¡æ¯ï¼Œè¯´æ˜ <code>zkfc</code> å¯åŠ¨æˆåŠŸ</p><p>æŸ¥çœ‹ <code>namenode</code>  æ—¥å¿—ä¿¡æ¯(åè¾¹çš„ <code>hbase1</code> æ˜¯ä½ çš„ä¸»æœºåç§°ï¼Œå…¶ä»–ä¸¤å°æ ¹æ®å®é™…æƒ…å†µæ›´æ¢ä¸»æœºåå³å¯)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1 ~]# /var/log/hadoop/hadoop-hadoop-namenode-hbase1.log</span><br></pre></td></tr></table></figure><p>é€šè¿‡æµè§ˆå™¨è®¿é—® <code>&lt;hostname&gt;:50070</code> å¯ä»¥çœ‹åˆ°ä¸¤å° <code>namenode</code> å…¶ä¸­ä¸€å°å¤„äº <code>active</code> çŠ¶æ€ï¼Œå¦ä¸€å°å¤„äº <code>standby</code> çŠ¶æ€ï¼Œè¯´æ˜ <code>zkfc</code>  åˆå§‹åŒ–å·¥ä½œå®Œæˆ</p><h3 id="4-å¯åŠ¨-DataNode"><a href="#4-å¯åŠ¨-DataNode" class="headerlink" title="4. å¯åŠ¨ DataNode"></a>4. å¯åŠ¨ DataNode</h3><p>åœ¨ä¸‰å°æœºå™¨ï¼Œæ‰§è¡Œä»¥ä¸‹ä»£ç è¿›è¡Œå¯åŠ¨ <code>datanode</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨ datanode</span></span><br><span class="line">[hadoop@hbase1(hbase2,hbase3) ~]# $HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs start datanode</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ä¸‰å°<code>datanode</code>åˆ†åˆ«æŸ¥çœ‹ç›¸å…³è¿›ç¨‹ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1 ~]$ jps</span><br><span class="line">15792 NameNode</span><br><span class="line">15908 DFSZKFailoverController</span><br><span class="line">5339 Jps</span><br><span class="line">16014 DataNode</span><br><span class="line">15231 JournalNode</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿”å›ä¿¡æ¯ï¼Œå¦‚æœæ˜¾ç¤ºäº† <code>DataNode</code>  è¿›ç¨‹ï¼Œä¸”æŸ¥çœ‹æ—¥å¿—æ²¡æœ‰å‘ç°ç›¸å…³é”™è¯¯ä¿¡æ¯ï¼Œè¯´æ˜ <code>DataNode</code>  å¯åŠ¨æˆåŠŸ</p><p>æŸ¥çœ‹ <code>DataNode</code>  æ—¥å¿—ä¿¡æ¯(åè¾¹çš„ <code>hbase1</code> æ˜¯ä½ çš„ä¸»æœºåç§°ï¼Œå…¶ä»–ä¸¤å°æ ¹æ®å®é™…æƒ…å†µæ›´æ¢ä¸»æœºåå³å¯)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1 ~]# /var/log/hadoop/hadoop-hadoop-datanode-hbase1.log</span><br></pre></td></tr></table></figure><h2 id="åˆå§‹åŒ–-HBase"><a href="#åˆå§‹åŒ–-HBase" class="headerlink" title="åˆå§‹åŒ– HBase"></a>åˆå§‹åŒ– HBase</h2><blockquote><p>åœ¨é¦–æ¬¡å¯åŠ¨ HBase ä¹‹å‰ï¼Œè¯·ä¿è¯ hdfs æ‰€æœ‰æœåŠ¡éƒ½å¤„äºå¼€å¯çŠ¶æ€ï¼Œzookeeper å¤„äºå¼€å¯çŠ¶æ€</p></blockquote><p>å°† hbase ç”¨æˆ·æ·»åŠ åˆ° supergroup ç»„ä¸­</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# groupadd supergroup</span><br><span class="line">[root@localhost ~]# groupmems -g supergroup -a hbase</span><br></pre></td></tr></table></figure><p>åˆ‡æ¢åˆ° hbase ç”¨æˆ·</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# su - hbase</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨ HMaster,åªåœ¨ç¬¬ä¸€å°æ‰§è¡Œ</span></span><br><span class="line">[hbase@hbase1 ~]# $HBASE_HOME/bin/hbase-daemon.sh start master</span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨ HRegionserverï¼Œä¸‰å°éƒ½æ‰§è¡Œ</span></span><br><span class="line">[hbase@hbase1(hbase2,hbase3) ~]# $HBASE_HOME/bin/hbase-daemon.sh start regionserver</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ä¸‰å°æœºå™¨åˆ†åˆ«æŸ¥çœ‹ç›¸å…³è¿›ç¨‹ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hbase@hbase1 zookeeper]$ jps</span><br><span class="line">32628 HMaster</span><br><span class="line">5991 Jps</span><br><span class="line">3309 Main</span><br><span class="line">32383 HRegionServer</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿”å›ä¿¡æ¯ï¼Œå¦‚æœåœ¨ç¬¬ä¸€å°æ˜¾ç¤ºäº† <code>Hmaster</code> å¹¶ä¸”è¿™ä¸‰å°éƒ½æ˜¾ç¤ºäº† <code>HRegionServer</code>  è¿›ç¨‹ï¼Œä¸”æŸ¥çœ‹æ—¥å¿—æ²¡æœ‰å‘ç°ç›¸å…³é”™è¯¯ä¿¡æ¯ï¼Œè¯´æ˜ <code>HRegionServer</code>  å¯åŠ¨æˆåŠŸ</p><p>æŸ¥çœ‹ <code>HRegionServer</code>  æ—¥å¿—ä¿¡æ¯(åè¾¹çš„ <code>hbase1</code> æ˜¯ä½ çš„ä¸»æœºåç§°ï¼Œå…¶ä»–ä¸¤å°æ ¹æ®å®é™…æƒ…å†µæ›´æ¢ä¸»æœºåå³å¯)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹ HMaster æ—¥å¿—ä¿¡æ¯</span></span><br><span class="line">[hbase@hbase1 ~]# tail -f /var/log/hbase/hbase-hbase-master-hbase1.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹ HRegionserver æ—¥å¿—ä¿¡æ¯</span></span><br><span class="line">[hbase@hbase1(hbase2,hbase3) ~]# tail -f /var/log/hbase/hbase-hbase-regionserver-hbase1.log</span><br></pre></td></tr></table></figure><h2 id="å¯åŠ¨é¡ºåº"><a href="#å¯åŠ¨é¡ºåº" class="headerlink" title="å¯åŠ¨é¡ºåº"></a>å¯åŠ¨é¡ºåº</h2><blockquote><p>æ³¨æ„ï¼šå¯åŠ¨æ—¶å¿…é¡»æŒ‰ç…§å¯åŠ¨é¡ºåºå¯åŠ¨ï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°æŸäº›æœªçŸ¥çš„å¯åŠ¨å¤±è´¥çš„æƒ…å†µ</p></blockquote><h3 id="Zookeeper-ç›¸å…³"><a href="#Zookeeper-ç›¸å…³" class="headerlink" title="Zookeeper ç›¸å…³"></a>Zookeeper ç›¸å…³</h3><p>å…ˆå¯åŠ¨ <code>zookeeper</code> ã€‚æ³¨æ„å…ˆåˆ‡æ¢åˆ° zookeeper ç”¨æˆ·åå†è¿›è¡Œå¯åŠ¨ï¼</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[zookeeper@hbase1(hbase2,hbase3) ~]# $ZOOKEEPER_HOME/bin/zkServer.sh start</span><br></pre></td></tr></table></figure><h3 id="Hadoop-ç›¸å…³"><a href="#Hadoop-ç›¸å…³" class="headerlink" title="Hadoop ç›¸å…³"></a>Hadoop ç›¸å…³</h3><p>å†å¯åŠ¨ <code>journalnode</code> ã€‚æ³¨æ„å…ˆåˆ‡æ¢åˆ° hadoop ç”¨æˆ·åå†è¿›è¡Œå¯åŠ¨ï¼(hbase1,hbase2)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1(hbase2) ~]# $HADOOP_HOME/sbin/hadoop-daemon.sh start journalnode</span><br></pre></td></tr></table></figure><p>å†å¯åŠ¨ <code>namenode</code> ã€‚æ³¨æ„å…ˆåˆ‡æ¢åˆ° hadoop ç”¨æˆ·åå†è¿›è¡Œå¯åŠ¨ï¼(hbase1,hbase2)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1(hbase2) ~]# $HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs start namenode</span><br></pre></td></tr></table></figure><p>å†å¯åŠ¨ <code>zkfc</code> ã€‚æ³¨æ„å…ˆåˆ‡æ¢åˆ° hadoop ç”¨æˆ·åå†è¿›è¡Œå¯åŠ¨ï¼(hbase1,hbase2)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1(hbase2) ~]# $HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs start zkfc</span><br></pre></td></tr></table></figure><p>å†å¯åŠ¨ <code>datanode</code> ã€‚æ³¨æ„å…ˆåˆ‡æ¢åˆ° hadoop ç”¨æˆ·åå†è¿›è¡Œå¯åŠ¨ï¼(hbase1,hbase2,hbase3)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hbase1(hbase2,hbase3) ~]# $HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs start datanode</span><br></pre></td></tr></table></figure><h3 id="HBase-ç›¸å…³"><a href="#HBase-ç›¸å…³" class="headerlink" title="HBase ç›¸å…³"></a>HBase ç›¸å…³</h3><p>å†å¯åŠ¨ <code>HMaster</code> ã€‚æ³¨æ„å…ˆåˆ‡æ¢åˆ° hbase ç”¨æˆ·åå†è¿›è¡Œå¯åŠ¨ï¼(hbase1)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hbase@hbase1 ~]# $HBASE_HOME/bin/hbase-daemon.sh start master</span><br></pre></td></tr></table></figure><p>å†å¯åŠ¨ <code>HRegionServer</code> ã€‚æ³¨æ„å…ˆåˆ‡æ¢åˆ° hbase ç”¨æˆ·åå†è¿›è¡Œå¯åŠ¨ï¼(hbase1,hbase2,hbase3)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hbase@hbase1(hbase2,hbase3) ~]# $HBASE_HOME/bin/hbase-daemon.sh start regionserver</span><br></pre></td></tr></table></figure><h2 id="å…³é—­é¡ºåº"><a href="#å…³é—­é¡ºåº" class="headerlink" title="å…³é—­é¡ºåº"></a>å…³é—­é¡ºåº</h2><blockquote><p>å…³é—­é¡ºåºè¯·å‚ç…§å¯åŠ¨é¡ºåºï¼Œåç€æ¥ä¸€è¾¹å°±å¯ä»¥</p></blockquote><h2 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Zookeeperç›¸å…³</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨zookeeperé›†ç¾¤</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ZOOKEEPER_HOME/bin/zkServer.sh start</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹zookeeperé›†ç¾¤çŠ¶æ€</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ZOOKEEPER_HOME/bin/zkServer.sh status</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åœæ­¢zookeeperé›†ç¾¤</span></span><br><span class="line"><span class="meta">$</span><span class="bash">ZOOKEEPER_HOME/bin/zkServer.sh stop</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Hadoopç›¸å…³</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨journalnode</span></span><br><span class="line"><span class="meta">$</span><span class="bash">HADOOP_HOME/sbin/hadoop-daemon.sh start journalnode</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åœæ­¢journalnode</span></span><br><span class="line"><span class="meta">$</span><span class="bash">HADOOP_HOME/sbin/hadoop-daemon.sh stop journalnode</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨namenode</span></span><br><span class="line"><span class="meta">$</span><span class="bash">HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs start namenode</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åœæ­¢namenode</span></span><br><span class="line"><span class="meta">$</span><span class="bash">HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs stop namenode</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨zkfc</span></span><br><span class="line"><span class="meta">$</span><span class="bash">HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs start zkfc</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åœæ­¢zkfc</span></span><br><span class="line"><span class="meta">$</span><span class="bash">HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs stop zkfc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨datanode</span></span><br><span class="line"><span class="meta">$</span><span class="bash">HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs start datanode</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åœæ­¢datanode</span></span><br><span class="line"><span class="meta">$</span><span class="bash">HADOOP_HOME/sbin/hadoop-daemon.sh --script hdfs stop datanode</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> HBaseç›¸å…³</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨HMaster</span></span><br><span class="line"><span class="meta">$</span><span class="bash">HBASE_HOME/bin/hbase-daemon.sh start master</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åœæ­¢HMaster</span></span><br><span class="line"><span class="meta">$</span><span class="bash">HBASE_HOME/bin/hbase-daemon.sh stop master</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨HRegionServer</span></span><br><span class="line"><span class="meta">$</span><span class="bash">HBASE_HOME/bin/hbase-daemon.sh start regionserver</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åœæ­¢HRegionServer</span></span><br><span class="line"><span class="meta">$</span><span class="bash">HBASE_HOME/bin/hbase-daemon.sh stop regionserver</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Hadoop </tag>
            
            <tag> HBase </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Druid SQLè§£æå·¥å…·çš„ä½¿ç”¨</title>
      <link href="/posts/6d9855d0/"/>
      <url>/posts/6d9855d0/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æœ€è¿‘åœ¨é¡¹ç›®è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œéœ€è¦å¯¹æ ‡å‡†SQLè¿›è¡Œè§£æï¼Œç„¶åå¯¹SQLè¿›è¡Œæ”¹å†™ï¼Œåœ¨å„ç§æŸ¥æ‰¾å¯¹æ¯”åé€‰ä¸­äº†Alibaba Druidæ¥è¿›è¡Œè§£æSQLï¼ˆå¦‚éç‰¹åˆ¶ï¼Œä»¥ä¸‹å‡ç®€ç§° Druidï¼‰</p><p>Druidå®˜æ–¹çš„wikiè¯´çš„è¿˜ç®—æ˜ç™½ï¼Œä½†å¯æƒœçš„æ˜¯æ²¡æœ‰ç›¸å…³APIæ–‡æ¡£ã€‚</p><h1 id="å®˜æ–¹æ–‡æ¡£"><a href="#å®˜æ–¹æ–‡æ¡£" class="headerlink" title="å®˜æ–¹æ–‡æ¡£"></a>å®˜æ–¹æ–‡æ¡£</h1><h2 id="1-SQL-Parser"><a href="#1-SQL-Parser" class="headerlink" title="1. SQL Parser"></a>1. SQL Parser</h2><p>å¦‚éœ€æŸ¥çœ‹åŸæ–‡ï¼š<a href="https://github.com/alibaba/druid/wiki/SQL-Parser" target="_blank" rel="noopener">SQL Parser</a></p><h3 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h3><p>SQL Parseræ˜¯Druidçš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼ŒDruidå†…ç½®ä½¿ç”¨SQL Parseræ¥å®ç°é˜²å¾¡SQLæ³¨å…¥ï¼ˆ<a href="https://github.com/alibaba/druid/wiki/%E7%AE%80%E4%BB%8B_WallFilter" target="_blank" rel="noopener">WallFilter</a>ï¼‰ã€åˆå¹¶ç»Ÿè®¡æ²¡æœ‰å‚æ•°åŒ–çš„SQL(<a href="https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatFilter" target="_blank" rel="noopener">StatFilter</a>çš„mergeSql)ã€<a href="https://github.com/alibaba/druid/wiki/SQL%E6%A0%BC%E5%BC%8F%E5%8C%96" target="_blank" rel="noopener">SQLæ ¼å¼åŒ–</a>ã€åˆ†åº“åˆ†è¡¨ã€‚</p><h4 id="1-1-å’ŒAntlrç”ŸæˆParserçš„åŒºåˆ«"><a href="#1-1-å’ŒAntlrç”ŸæˆParserçš„åŒºåˆ«" class="headerlink" title="1.1. å’ŒAntlrç”ŸæˆParserçš„åŒºåˆ«"></a>1.1. å’ŒAntlrç”ŸæˆParserçš„åŒºåˆ«</h4><p>å’ŒAntlrç”Ÿæˆçš„SQLæœ‰å¾ˆå¤§ä¸åŒçš„æ˜¯ï¼ŒDruid SQL Parseræ€§èƒ½éå¸¸å¥½ï¼Œå¯ä»¥ç”¨äºç”Ÿäº§ç¯å¢ƒç›´æ¥å¯¹SQLè¿›è¡Œåˆ†æå¤„ç†ã€‚</p><h4 id="1-2-Druid-SQL-Parserçš„ä½¿ç”¨åœºæ™¯"><a href="#1-2-Druid-SQL-Parserçš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="1.2. Druid SQL Parserçš„ä½¿ç”¨åœºæ™¯"></a>1.2. Druid SQL Parserçš„ä½¿ç”¨åœºæ™¯</h4><ul><li>MySql SQLå…¨é‡ç»Ÿè®¡</li><li>Hive/<a href="https://www.aliyun.com/product/odps" target="_blank" rel="noopener">ODPS</a> SQLæ‰§è¡Œå®‰å…¨å®¡è®¡</li><li>åˆ†åº“åˆ†è¡¨SQLè§£æå¼•æ“</li><li>æ•°æ®åº“å¼•æ“çš„SQL Parser</li></ul><h3 id="2-å„ç§è¯­æ³•æ”¯æŒ"><a href="#2-å„ç§è¯­æ³•æ”¯æŒ" class="headerlink" title="2. å„ç§è¯­æ³•æ”¯æŒ"></a>2. å„ç§è¯­æ³•æ”¯æŒ</h3><p>Druidçš„sql parseræ˜¯ç›®å‰æ”¯æŒå„ç§æ•°æ®è¯­æ³•æœ€å®Œå¤‡çš„SQL Parserã€‚ç›®å‰å¯¹å„ç§æ•°æ®åº“çš„æ”¯æŒå¦‚ä¸‹ï¼š</p><table><thead><tr><th>æ•°æ®åº“</th><th>DML</th><th>DDL</th></tr></thead><tbody><tr><td><a href="https://www.aliyun.com/product/odps" target="_blank" rel="noopener">odps</a></td><td>å®Œå…¨æ”¯æŒ</td><td>å®Œå…¨æ”¯æŒ</td></tr><tr><td>mysql</td><td>å®Œå…¨æ”¯æŒ</td><td>å®Œå…¨æ”¯æŒ</td></tr><tr><td>postgresql</td><td>å®Œå…¨æ”¯æŒ</td><td>å®Œå…¨æ”¯æŒ</td></tr><tr><td>oracle</td><td>æ”¯æŒå¤§éƒ¨åˆ†</td><td>æ”¯æŒå¤§éƒ¨åˆ†</td></tr><tr><td>sql server</td><td>æ”¯æŒå¸¸ç”¨çš„</td><td>æ”¯æŒå¸¸ç”¨çš„ddl</td></tr><tr><td>db2</td><td>æ”¯æŒå¸¸ç”¨çš„</td><td>æ”¯æŒå¸¸ç”¨çš„ddl</td></tr><tr><td>hive</td><td>æ”¯æŒå¸¸ç”¨çš„</td><td>æ”¯æŒå¸¸ç”¨çš„ddl</td></tr></tbody></table><p>druidè¿˜ç¼ºçœæ”¯æŒsql-92æ ‡å‡†çš„è¯­æ³•ï¼Œæ‰€ä»¥ä¹Ÿéƒ¨åˆ†æ”¯æŒå…¶ä»–æ•°æ®åº“çš„sqlè¯­æ³•ã€‚</p><h3 id="3-æ€§èƒ½"><a href="#3-æ€§èƒ½" class="headerlink" title="3. æ€§èƒ½"></a>3. æ€§èƒ½</h3><p>Druidçš„SQL Parseræ˜¯æ‰‹å·¥ç¼–å†™ï¼Œæ€§èƒ½éå¸¸å¥½ï¼Œç›®æ ‡å°±æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œæ—¶ä½¿ç”¨çš„SQL Parserï¼Œæ€§èƒ½æ¯”antlrã€javaccä¹‹ç±»å·¥å…·ç”Ÿæˆçš„Parserå¿«10å€ç”šè‡³100å€ä»¥ä¸Šã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">ID</span>, <span class="keyword">NAME</span>, AGE <span class="keyword">FROM</span> <span class="keyword">USER</span> <span class="keyword">WHERE</span> <span class="keyword">ID</span> = ?</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„SQLï¼Œdruid parserå¤„ç†å¤§çº¦æ˜¯600çº³ç§’ï¼Œä¹Ÿå°±æ˜¯è¯´å•çº¿ç¨‹æ¯ç§’å¯ä»¥å¤„ç†1500ä¸‡æ¬¡ä»¥ä¸Šã€‚åœ¨1.1.3~1.1.4ç‰ˆæœ¬ä¸­ï¼ŒSQL Parserçš„æ€§èƒ½æœ‰æå¤§æå‡ï¼Œå®Œå…¨å¯ä»¥é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­å¯¹SQLè¿›è¡Œå¤„ç†ã€‚</p><h4 id="3-1-æµ‹è¯•ä»£ç çœ‹è¿™é‡Œ"><a href="#3-1-æµ‹è¯•ä»£ç çœ‹è¿™é‡Œ" class="headerlink" title="3.1. æµ‹è¯•ä»£ç çœ‹è¿™é‡Œ"></a>3.1. æµ‹è¯•ä»£ç çœ‹è¿™é‡Œ</h4><p><a href="https://github.com/alibaba/druid/blob/master/src/test/java/com/alibaba/druid/benckmark/sql/MySqlPerfTest.java" target="_blank" rel="noopener">MySqlPerfTest.java</a></p><h3 id="4-Druid-SQL-Parserçš„ä»£ç ç»“æ„"><a href="#4-Druid-SQL-Parserçš„ä»£ç ç»“æ„" class="headerlink" title="4. Druid SQL Parserçš„ä»£ç ç»“æ„"></a>4. Druid SQL Parserçš„ä»£ç ç»“æ„</h3><p>Druid SQL Parseråˆ†ä¸‰ä¸ªæ¨¡å—ï¼š</p><ul><li>Parser</li><li>AST</li><li>Visitor</li></ul><h4 id="4-1-parser"><a href="#4-1-parser" class="headerlink" title="4.1. parser"></a>4.1. parser</h4><p>parseræ˜¯å°†è¾“å…¥æ–‡æœ¬è½¬æ¢ä¸ºastï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼Œparseræœ‰åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼ŒParserå’ŒLexerï¼Œå…¶ä¸­Lexerå®ç°è¯æ³•åˆ†æï¼ŒParserå®ç°è¯­æ³•åˆ†æã€‚</p><h4 id="4-2-AST"><a href="#4-2-AST" class="headerlink" title="4.2. AST"></a>4.2. AST</h4><p>ASTæ˜¯Abstract Syntax Treeçš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯æŠ½è±¡è¯­æ³•æ ‘ã€‚ASTæ˜¯parserè¾“å‡ºçš„ç»“æœã€‚ä¸‹é¢æ˜¯è·å¾—æŠ½è±¡è¯­æ³•æ ‘çš„ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> String dbType = JdbcConstants.MYSQL; <span class="comment">// å¯ä»¥æ˜¯ORACLEã€POSTGRESQLã€SQLSERVERã€ODPSç­‰</span></span><br><span class="line">String sql = <span class="string">"select * from t"</span>;</span><br><span class="line">List&lt;SQLStatement&gt; stmtList = SQLUtils.parseStatements(sql, dbType);</span><br></pre></td></tr></table></figure><ul><li>Druid SQL ASTä»‹ç» <a href="https://github.com/alibaba/druid/wiki/Druid_SQL_AST" target="_blank" rel="noopener">https://github.com/alibaba/druid/wiki/Druid_SQL_AST</a></li></ul><h4 id="4-3-Visitor"><a href="#4-3-Visitor" class="headerlink" title="4.3. Visitor"></a>4.3. Visitor</h4><p>Visitoræ˜¯éå†ASTçš„æ‰‹æ®µï¼Œæ˜¯å¤„ç†ASTæœ€æ–¹ä¾¿çš„æ¨¡å¼ï¼ŒVisitoræ˜¯ä¸€ä¸ªæ¥å£ï¼Œæœ‰ç¼ºçœä»€ä¹ˆéƒ½æ²¡åšçš„å®ç°VistorAdapterã€‚</p><p>æˆ‘ä»¬å¯ä»¥å®ç°ä¸åŒçš„Visitoræ¥æ»¡è¶³ä¸åŒçš„éœ€æ±‚ï¼ŒDruidå†…ç½®æä¾›äº†å¦‚ä¸‹Visitor: </p><ul><li>OutputVisitorç”¨æ¥æŠŠASTè¾“å‡ºä¸ºå­—ç¬¦ä¸²</li><li><a href="https://github.com/alibaba/druid/wiki/%E7%AE%80%E4%BB%8B_WallFilter" target="_blank" rel="noopener">WallVisitor</a> æ¥åˆ†æSQLè¯­æ„æ¥é˜²å¾¡SQLæ³¨å…¥æ”»å‡»</li><li>ParameterizedOutputVisitorç”¨æ¥åˆå¹¶æœªå‚æ•°åŒ–çš„SQLè¿›è¡Œç»Ÿè®¡</li><li><a href="https://github.com/alibaba/druid/wiki/EvalVisitor" target="_blank" rel="noopener">EvalVisitor</a> ç”¨æ¥å¯¹SQLè¡¨è¾¾å¼æ±‚å€¼</li><li>ExportParameterVisitorç”¨æ¥æå–SQLä¸­çš„å˜é‡å‚æ•°</li><li><a href="https://github.com/alibaba/druid/wiki/SchemaStatVisitor" target="_blank" rel="noopener">SchemaStatVisitor</a> ç”¨æ¥ç»Ÿè®¡SQLä¸­ä½¿ç”¨çš„è¡¨ã€å­—æ®µã€è¿‡æ»¤æ¡ä»¶ã€æ’åºè¡¨è¾¾å¼ã€åˆ†ç»„è¡¨è¾¾å¼</li><li><a href="https://github.com/alibaba/druid/wiki/SQL_Format" target="_blank" rel="noopener">SQLæ ¼å¼åŒ–</a> Druidå†…ç½®äº†åŸºäºè¯­ä¹‰çš„SQLæ ¼å¼åŒ–åŠŸèƒ½</li></ul><h4 id="4-4-è‡ªå®šä¹‰Visitor"><a href="#4-4-è‡ªå®šä¹‰Visitor" class="headerlink" title="4.4. è‡ªå®šä¹‰Visitor"></a>4.4. è‡ªå®šä¹‰Visitor</h4><p>æ¯ç§æ–¹è¨€çš„Visitoréƒ½æœ‰ä¸€ä¸ªç¼ºçœçš„VisitorAdapterï¼Œä½¿å¾—ç¼–å†™è‡ªå®šä¹‰çš„Visitoræ›´æ–¹ä¾¿ã€‚<br><a href="https://github.com/alibaba/druid/wiki/SQL_Parser_Demo_visitor" target="_blank" rel="noopener">https://github.com/alibaba/druid/wiki/SQL_Parser_Demo_visitor</a></p><h4 id="4-5-è‡ªå®šä¹‰visitorç¤ºä¾‹"><a href="#4-5-è‡ªå®šä¹‰visitorç¤ºä¾‹" class="headerlink" title="4.5 è‡ªå®šä¹‰visitorç¤ºä¾‹"></a>4.5 è‡ªå®šä¹‰visitorç¤ºä¾‹</h4><h5 id="1-å®ç°è‡ªå·±çš„Visitor"><a href="#1-å®ç°è‡ªå·±çš„Visitor" class="headerlink" title="1. å®ç°è‡ªå·±çš„Visitor"></a>1. å®ç°è‡ªå·±çš„Visitor</h5><h6 id="1-1-Oracleç‰ˆæœ¬"><a href="#1-1-Oracleç‰ˆæœ¬" class="headerlink" title="1.1 Oracleç‰ˆæœ¬"></a>1.1 Oracleç‰ˆæœ¬</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExportTableAliasVisitor</span> <span class="keyword">extends</span> <span class="title">OracleASTVisitorAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, SQLTableSource&gt; aliasMap = <span class="keyword">new</span> HashMap&lt;String, SQLTableSource&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">visit</span><span class="params">(OracleSelectTableReference x)</span> </span>&#123;</span><br><span class="line">        String alias = x.getAlias();</span><br><span class="line">        aliasMap.put(alias, x);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, SQLTableSource&gt; <span class="title">getAliasMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> aliasMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="1-2-MySqlç‰ˆæœ¬"><a href="#1-2-MySqlç‰ˆæœ¬" class="headerlink" title="1.2 MySqlç‰ˆæœ¬"></a>1.2 MySqlç‰ˆæœ¬</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExportTableAliasVisitor</span> <span class="keyword">extends</span> <span class="title">MySqlASTVisitorAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, SQLTableSource&gt; aliasMap = <span class="keyword">new</span> HashMap&lt;String, SQLTableSource&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">visit</span><span class="params">(SQLExprTableSource x)</span> </span>&#123;</span><br><span class="line">        String alias = x.getAlias();</span><br><span class="line">        aliasMap.put(alias, x);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, SQLTableSource&gt; <span class="title">getAliasMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> aliasMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="1-3-POSTGRESQLç‰ˆæœ¬"><a href="#1-3-POSTGRESQLç‰ˆæœ¬" class="headerlink" title="1.3 POSTGRESQLç‰ˆæœ¬"></a>1.3 POSTGRESQLç‰ˆæœ¬</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExportTableAliasVisitor</span> <span class="keyword">extends</span> <span class="title">PGASTVisitorAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, SQLTableSource&gt; aliasMap = <span class="keyword">new</span> HashMap&lt;String, SQLTableSource&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">visit</span><span class="params">(SQLExprTableSource x)</span> </span>&#123;</span><br><span class="line">        String alias = x.getAlias();</span><br><span class="line">        aliasMap.put(alias, x);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, SQLTableSource&gt; <span class="title">getAliasMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> aliasMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-ä½¿ç”¨Visitor"><a href="#2-ä½¿ç”¨Visitor" class="headerlink" title="2. ä½¿ç”¨Visitor"></a>2. ä½¿ç”¨Visitor</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">finnal String dbType = JdbcConstants.ORACLE; <span class="comment">// JdbcConstants.MYSQLæˆ–è€…JdbcConstants.POSTGRESQL</span></span><br><span class="line">String sql = <span class="string">"select * from mytable a where a.id = 3"</span>;</span><br><span class="line">List&lt;SQLStatement&gt; stmtList = SQLUtils.parseStatements(sql, dbType);</span><br><span class="line"></span><br><span class="line">ExportTableAliasVisitor visitor = <span class="keyword">new</span> ExportTableAliasVisitor();</span><br><span class="line"><span class="keyword">for</span> (SQLStatement stmt : stmtList) &#123;</span><br><span class="line">    stmt.accept(visitor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SQLTableSource tableSource = visitor.getAliasMap().get(<span class="string">"a"</span>);</span><br><span class="line">System.out.println(tableSource);</span><br></pre></td></tr></table></figure><h4 id="4-6-æ–¹è¨€"><a href="#4-6-æ–¹è¨€" class="headerlink" title="4.6. æ–¹è¨€"></a>4.6. æ–¹è¨€</h4><p>SQL-92ã€SQL-99ç­‰éƒ½æ˜¯æ ‡å‡†SQLï¼Œmysql/oracle/pg/sqlserver/odpsç­‰éƒ½æ˜¯æ–¹è¨€ï¼Œä¹Ÿå°±æ˜¯dialectã€‚parser/ast/visitoréƒ½éœ€è¦é’ˆå¯¹ä¸åŒçš„æ–¹è¨€è¿›è¡Œç‰¹åˆ«å¤„ç†ã€‚</p><h3 id="5-SchemaRepository"><a href="#5-SchemaRepository" class="headerlink" title="5. SchemaRepository"></a>5. SchemaRepository</h3><p>Druid SQL Parserå†…ç½®äº†ä¸€ä¸ªSchemaRepositoryï¼Œåœ¨å†…å­˜ä¸­ç¼“å­˜SQL Schemaä¿¡æ¯ï¼Œç”¨äºSQLè¯­ä¹‰è§£æä¸­çš„ColumnResolveç­‰æ“ä½œã€‚<br><a href="https://github.com/alibaba/druid/wiki/SQL_Schema_Repository" target="_blank" rel="noopener">https://github.com/alibaba/druid/wiki/SQL_Schema_Repository</a></p><h3 id="6-SQLç¿»è¯‘"><a href="#6-SQLç¿»è¯‘" class="headerlink" title="6. SQLç¿»è¯‘"></a>6. SQLç¿»è¯‘</h3><p>å¯ä»¥åŸºäºDruid SQL Parserä¹‹ä¸Šæ„é€ Oracle SQLåˆ°å…¶ä»–æ•°æ®çš„SQLç¿»è¯‘ã€‚æ¯”å¦‚Aliyunæä¾›çš„Oracleåˆ°MySqlçš„<a href="https://rainbow-expert.aliyun.com/sqltransform.htm" target="_blank" rel="noopener">SQLç¿»è¯‘åŠŸèƒ½</a>ï¼Œå°±æ˜¯åŸºäºDruidåŸºç¡€ä¸Šå®ç°çš„ã€‚<a href="https://rainbow-expert.aliyun.com/sqltransform.htm" target="_blank" rel="noopener">https://rainbow-expert.aliyun.com/sqltransform.htm</a></p><h2 id="2-SQL-Formatter"><a href="#2-SQL-Formatter" class="headerlink" title="2. SQL Formatter"></a>2. SQL Formatter</h2><p>Druid SQL Parseræä¾›äº†æ ¼å¼åŒ–ä»£ç çš„å·¥å…·ç±»ã€‚è¿™ä¸ªæ˜¯åŸºäºè¯­ä¹‰åˆ†æåšçš„SQLæ ¼å¼åŒ–åŠŸèƒ½ï¼Œæ¯”å…¶ä»–çš„SQLæ ¼å¼åŒ–åšçš„æ›´æ™ºèƒ½ï¼Œæ•ˆæœæ›´å¥½ã€‚</p><h3 id="æ ¼å¼åŒ–çš„å·¥å…·ç±»API"><a href="#æ ¼å¼åŒ–çš„å·¥å…·ç±»API" class="headerlink" title="æ ¼å¼åŒ–çš„å·¥å…·ç±»API"></a>æ ¼å¼åŒ–çš„å·¥å…·ç±»API</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.druid.sql;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SQLUtils</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">format</span><span class="params">(String sq, String dbType)</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">format</span><span class="params">(String sq, String dbType, FormatOption option)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å…¶ä¸­dbTypeæ”¯æŒmysql/postgresql/odps/oracle/db2/sqlserver</li><li>optionç¼ºçœæœ‰SQLUtils.DEFAULT_FORMAT_OPTIONï¼ˆå¤§å†™ï¼‰ã€SQLUtils.DEFAULT_LCASE_FORMAT_OPTIONï¼ˆå°å†™ï¼‰ä¸¤ç§å¯ä»¥é€‰æ‹©ï¼Œä¹Ÿå¯æŒ‰éœ€è¦å®šåˆ¶åŒ–ã€‚</li></ul><h3 id="MySQL-æ ¼å¼åŒ–"><a href="#MySQL-æ ¼å¼åŒ–" class="headerlink" title="MySQL æ ¼å¼åŒ–"></a>MySQL æ ¼å¼åŒ–</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.druid.sql.SQLUtils;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.util.JdbcConstants;</span><br><span class="line"></span><br><span class="line">String sql = <span class="string">"update t set name = 'x' where id &lt; 100 limit 10"</span>;</span><br><span class="line">String result = SQLUtils.format(sql, JdbcConstants.MYSQL);</span><br><span class="line">System.out.println(result); <span class="comment">// ç¼ºçœå¤§å†™æ ¼å¼</span></span><br><span class="line"></span><br><span class="line">String result_lcase = SQLUtils.format(sql</span><br><span class="line">                         , JdbcConstants.MYSQL</span><br><span class="line">                         , SQLUtils.DEFAULT_LCASE_FORMAT_OPTION);</span><br><span class="line">System.out.println(result_lcase); <span class="comment">// å°å†™æ ¼å¼</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºæ ¼å¼åŒ–åçš„ç»“æœï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è¿™æ˜¯ç¼ºçœçš„å¤§å†™æ ¼å¼</span></span><br><span class="line"><span class="keyword">UPDATE</span> t</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">name</span> = <span class="string">'x'</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">id</span> &lt; <span class="number">100</span></span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è¿™æ˜¯å°å†™æ ¼å¼</span></span><br><span class="line"><span class="keyword">update</span> t</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">name</span> = <span class="string">'x'</span></span><br><span class="line"><span class="keyword">where</span> <span class="keyword">id</span> &lt; <span class="number">100</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><h2 id="3-SQL-Schema-Repository"><a href="#3-SQL-Schema-Repository" class="headerlink" title="3. SQL Schema Repository"></a>3. SQL Schema Repository</h2><h3 id="1-ç®€ä»‹-1"><a href="#1-ç®€ä»‹-1" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h3><p>Druid SQL Parserå†…ç½®äº†ä¸€ä¸ªSchemaRepositoryï¼Œåœ¨å†…å­˜ä¸­ç¼“å­˜SQL Schemaä¿¡æ¯ï¼Œç”¨äºSQLè¯­ä¹‰è§£æä¸­çš„ColumnResolveç­‰æ“ä½œã€‚</p><h3 id="2-å¦‚ä½•ä½¿ç”¨SchemaRepository"><a href="#2-å¦‚ä½•ä½¿ç”¨SchemaRepository" class="headerlink" title="2. å¦‚ä½•ä½¿ç”¨SchemaRepository"></a>2. å¦‚ä½•ä½¿ç”¨SchemaRepository</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.druid.sql.repository.SchemaRepository;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SchemaRepositoryæ˜¯å’Œæ•°æ®åº“ç±»å‹ç›¸å…³çš„ï¼Œæ„é€ æ—¶éœ€è¦ä¼ å…¥dbType</span></span><br><span class="line"><span class="keyword">final</span> String dbType = JdbcConstants.MYSQL;</span><br><span class="line">SchemaRepository repository = <span class="keyword">new</span> SchemaRepository(dbType);</span><br><span class="line"></span><br><span class="line">repository.console(<span class="string">"use sc00;"</span>);</span><br><span class="line"></span><br><span class="line">String sql = <span class="string">"CREATE TABLE `test1` (\n"</span> +</span><br><span class="line">        <span class="string">"  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_tinyint` tinyint(4) DEFAULT '1' COMMENT 'tinyint',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_smallint` smallint(6) DEFAULT 0 COMMENT 'smallint',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_mediumint` mediumint(9) DEFAULT NULL COMMENT 'mediumint',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_int` int(11) DEFAULT NULL COMMENT 'int',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_bigint` bigint(20) DEFAULT NULL COMMENT 'bigint',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_decimal` decimal(10,3) DEFAULT NULL COMMENT 'decimal',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_date` date DEFAULT '0000-00-00' COMMENT 'date',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_datetime` datetime DEFAULT '0000-00-00 00:00:00' COMMENT 'datetime',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_timestamp` timestamp NULL DEFAULT NULL COMMENT 'timestamp'  ON UPDATE CURRENT_TIMESTAMP ,\n"</span> +</span><br><span class="line">        <span class="string">"  `c_time` time DEFAULT NULL COMMENT 'time',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_char` char(10) DEFAULT NULL COMMENT 'char',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_varchar` varchar(10) DEFAULT 'hello' COMMENT 'varchar',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_blob` blob COMMENT 'blob',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_text` text COMMENT 'text',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_mediumtext` mediumtext COMMENT 'mediumtext',\n"</span> +</span><br><span class="line">        <span class="string">"  `c_longblob` longblob COMMENT 'longblob',\n"</span> +</span><br><span class="line">        <span class="string">"  PRIMARY KEY (`id`,`c_tinyint`),\n"</span> +</span><br><span class="line">        <span class="string">"  UNIQUE KEY `uk_a` (`c_varchar`,`c_mediumint`),\n"</span> +</span><br><span class="line">        <span class="string">"  KEY `k_c` (`c_tinyint`,`c_int`),\n"</span> +</span><br><span class="line">        <span class="string">"  KEY `k_d` (`c_char`,`c_bigint`)\n"</span> +</span><br><span class="line">        <span class="string">") ENGINE=InnoDB AUTO_INCREMENT=1769503 DEFAULT CHARSET=utf8mb4 COMMENT='10000000'"</span>;</span><br><span class="line"></span><br><span class="line">repository.console(sql);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨å¦‚ä¸‹çš„ä»£ç ä¸­å¯ä»¥çŸ¥é“repositoryä¸­å·²ç»å­˜åœ¨è¡¨test1</span></span><br><span class="line">MySqlCreateTableStatement createTableStmt = (MySqlCreateTableStatement) repository.findTable(<span class="string">"test1"</span>).getStatement();</span><br><span class="line">assertEquals(<span class="number">21</span>, createTableStmt.getTableElementList().size());</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡æ‰§è¡Œå‘½ä»¤"show columns from test1"å¯ä»¥è·å¾—mysql consoleé£æ ¼çš„è¾“å‡º</span></span><br><span class="line">assertEquals(<span class="string">"+--------------+---------------+------+-----+---------------------+-----------------------------+\n"</span> +</span><br><span class="line">        <span class="string">"| Field        | Type          | Null | Key | Default             | Extra                       |\n"</span> +</span><br><span class="line">        <span class="string">"+--------------+---------------+------+-----+---------------------+-----------------------------+\n"</span> +</span><br><span class="line">        <span class="string">"| id           | bigint(20)    | NO   | PRI | NULL                | auto_increment              |\n"</span> +</span><br><span class="line">        <span class="string">"| c_tinyint    | tinyint(4)    | YES  | PRI | 1                   |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_smallint   | smallint(6)   | YES  |     | 0                   |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_mediumint  | mediumint(9)  | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_int        | int(11)       | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_bigint     | bigint(20)    | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_decimal    | decimal(10,3) | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_date       | date          | YES  |     | 0000-00-00          |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_datetime   | datetime      | YES  |     | 0000-00-00 00:00:00 |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_timestamp  | timestamp     | YES  |     | NULL                | on update CURRENT_TIMESTAMP |\n"</span> +</span><br><span class="line">        <span class="string">"| c_time       | time          | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_char       | char(10)      | YES  | MUL | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_varchar    | varchar(10)   | YES  | MUL | hello               |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_blob       | blob          | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_text       | text          | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_mediumtext | mediumtext    | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_longblob   | longblob      | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"+--------------+---------------+------+-----+---------------------+-----------------------------+\n"</span>, </span><br><span class="line">repository.console(<span class="string">"show columns from test1"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œalterè¯­å¥ï¼Œä¿®æ”¹repositoryä¸­å†…å®¹</span></span><br><span class="line">repository.console(<span class="string">"alter table test1 drop column c_decimal;"</span>);</span><br><span class="line">assertEquals(<span class="number">20</span>, createTableStmt.getTableElementList().size());</span><br><span class="line"></span><br><span class="line">assertEquals(<span class="string">"+--------------+--------------+------+-----+---------------------+-----------------------------+\n"</span> +</span><br><span class="line">        <span class="string">"| Field        | Type         | Null | Key | Default             | Extra                       |\n"</span> +</span><br><span class="line">        <span class="string">"+--------------+--------------+------+-----+---------------------+-----------------------------+\n"</span> +</span><br><span class="line">        <span class="string">"| id           | bigint(20)   | NO   | PRI | NULL                | auto_increment              |\n"</span> +</span><br><span class="line">        <span class="string">"| c_tinyint    | tinyint(4)   | YES  | PRI | 1                   |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_smallint   | smallint(6)  | YES  |     | 0                   |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_mediumint  | mediumint(9) | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_int        | int(11)      | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_bigint     | bigint(20)   | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_date       | date         | YES  |     | 0000-00-00          |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_datetime   | datetime     | YES  |     | 0000-00-00 00:00:00 |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_timestamp  | timestamp    | YES  |     | NULL                | on update CURRENT_TIMESTAMP |\n"</span> +</span><br><span class="line">        <span class="string">"| c_time       | time         | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_char       | char(10)     | YES  | MUL | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_varchar    | varchar(10)  | YES  | MUL | hello               |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_blob       | blob         | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_text       | text         | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_mediumtext | mediumtext   | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"| c_longblob   | longblob     | YES  |     | NULL                |                             |\n"</span> +</span><br><span class="line">        <span class="string">"+--------------+--------------+------+-----+---------------------+-----------------------------+\n"</span>, </span><br><span class="line">repository.console(<span class="string">"show columns from test1"</span>));</span><br></pre></td></tr></table></figure><h3 id="3-Column-Resolve"><a href="#3-Column-Resolve" class="headerlink" title="3. Column Resolve"></a>3. Column Resolve</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> String dbType = JdbcConstants.MYSQL;</span><br><span class="line"></span><br><span class="line">SchemaRepository repository = <span class="keyword">new</span> SchemaRepository(dbType);</span><br><span class="line"></span><br><span class="line">repository.console(<span class="string">"create table t_emp(emp_id bigint, name varchar(20));"</span>);</span><br><span class="line">repository.console(<span class="string">"create table t_org(org_id bigint, name varchar(20));"</span>);</span><br><span class="line"></span><br><span class="line">String sql = <span class="string">"SELECT emp_id, a.name AS emp_name, org_id, b.name AS org_name\n"</span> +</span><br><span class="line">        <span class="string">"FROM t_emp a\n"</span> +</span><br><span class="line">        <span class="string">"\tINNER JOIN t_org b ON a.emp_id = b.org_id"</span>;</span><br><span class="line"></span><br><span class="line">List&lt;SQLStatement&gt; stmtList = SQLUtils.parseStatements(sql, dbType);</span><br><span class="line">assertEquals(<span class="number">1</span>, stmtList.size());</span><br><span class="line"></span><br><span class="line">SQLSelectStatement stmt = (SQLSelectStatement) stmtList.get(<span class="number">0</span>);</span><br><span class="line">SQLSelectQueryBlock queryBlock = stmt.getSelect().getQueryBlock();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤§å°å†™ä¸æ•æ„Ÿ</span></span><br><span class="line">assertNotNull(queryBlock.findTableSource(<span class="string">"A"</span>));</span><br><span class="line">assertSame(queryBlock.findTableSource(<span class="string">"a"</span>), queryBlock.findTableSource(<span class="string">"A"</span>));</span><br><span class="line"></span><br><span class="line">assertNull(queryBlock.findTableSourceWithColumn(<span class="string">"emp_id"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨repositoryåšcolumn resolve</span></span><br><span class="line">repository.resolve(stmt);</span><br><span class="line"></span><br><span class="line">assertNotNull(queryBlock.findTableSourceWithColumn(<span class="string">"emp_id"</span>));</span><br><span class="line"></span><br><span class="line">SQLExprTableSource tableSource = (SQLExprTableSource) queryBlock.findTableSourceWithColumn(<span class="string">"emp_id"</span>);</span><br><span class="line">assertNotNull(tableSource.getSchemaObject());</span><br><span class="line"></span><br><span class="line">SQLCreateTableStatement createTableStmt = (SQLCreateTableStatement) tableSource.getSchemaObject().getStatement();</span><br><span class="line">assertNotNull(createTableStmt);</span><br><span class="line"></span><br><span class="line">SQLSelectItem selectItem = queryBlock.findSelectItem(<span class="string">"org_name"</span>);</span><br><span class="line">assertNotNull(selectItem);</span><br><span class="line">SQLPropertyExpr selectItemExpr = (SQLPropertyExpr) selectItem.getExpr();</span><br><span class="line">SQLColumnDefinition column = selectItemExpr.getResolvedColumn();</span><br><span class="line">assertNotNull(column);</span><br><span class="line">assertEquals(<span class="string">"name"</span>, column.getName().toString());</span><br><span class="line">assertEquals(<span class="string">"t_org"</span>, (((SQLCreateTableStatement)column.getParent()).getName().toString()));</span><br><span class="line"></span><br><span class="line">assertSame(queryBlock.findTableSource(<span class="string">"B"</span>), selectItemExpr.getResolvedTableSource());</span><br></pre></td></tr></table></figure><h2 id="4-SQL-Parser-Parameterize"><a href="#4-SQL-Parser-Parameterize" class="headerlink" title="4. SQL Parser Parameterize"></a>4. SQL Parser Parameterize</h2><h3 id="1-åŠŸèƒ½ä»‹ç»"><a href="#1-åŠŸèƒ½ä»‹ç»" class="headerlink" title="1. åŠŸèƒ½ä»‹ç»"></a>1. åŠŸèƒ½ä»‹ç»</h3><p>å¦‚æœè¦å¯¹SQLåšå„ç§ç»Ÿè®¡ï¼Œé€šå¸¸éœ€è¦å¯¹SQLè¿›è¡Œå‚æ•°åŒ–å†åšç»Ÿè®¡ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// åŸå§‹SQL</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">// å‚æ•°åŒ–<span class="keyword">SQL</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">id</span> = ?</span><br></pre></td></tr></table></figure><h3 id="2-SQLå‚æ•°åŒ–"><a href="#2-SQLå‚æ•°åŒ–" class="headerlink" title="2. SQLå‚æ•°åŒ–"></a>2. SQLå‚æ•°åŒ–</h3><h4 id="2-1-SQLå‚æ•°åŒ–API"><a href="#2-1-SQLå‚æ•°åŒ–API" class="headerlink" title="2.1 SQLå‚æ•°åŒ–API"></a>2.1 SQLå‚æ•°åŒ–API</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.druid.sql.visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParameterizedOutputVisitorUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">parameterize</span><span class="params">(String sql, String dbType)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-SQLå‚æ•°åŒ–DEMO"><a href="#2-2-SQLå‚æ•°åŒ–DEMO" class="headerlink" title="2.2 SQLå‚æ•°åŒ–DEMO"></a>2.2 SQLå‚æ•°åŒ–DEMO</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.druid.sql.visitor.ParameterizedOutputVisitorUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> String dbType = JdbcConstants.MYSQL;</span><br><span class="line"></span><br><span class="line">String sql = <span class="string">"select * from t where id = 1 or id = 2 or id = 3"</span>;</span><br><span class="line">String psql = ParameterizedOutputVisitorUtils.parameterize(sql, dbType);</span><br><span class="line">assertEquals(<span class="string">"SELECT *\n"</span> +</span><br><span class="line">        <span class="string">"FROM t\n"</span> +</span><br><span class="line">        <span class="string">"WHERE id = ?"</span>, psql);</span><br></pre></td></tr></table></figure><h4 id="3-è·å–å…·ä½“å‚æ•°åŒ–åçš„å¸¸é‡å€¼"><a href="#3-è·å–å…·ä½“å‚æ•°åŒ–åçš„å¸¸é‡å€¼" class="headerlink" title="3. è·å–å…·ä½“å‚æ•°åŒ–åçš„å¸¸é‡å€¼"></a>3. è·å–å…·ä½“å‚æ•°åŒ–åçš„å¸¸é‡å€¼</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> String dbType = JdbcConstants.MYSQL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‚æ•°åŒ–SQLæ˜¯è¾“å‡ºçš„å‚æ•°ä¿å­˜åœ¨è¿™ä¸ªListä¸­</span></span><br><span class="line">List&lt;Object&gt; outParameters = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line">String sql = <span class="string">"select * from t where id = 101 and age = 102 or name = 'wenshao'"</span>;</span><br><span class="line">String psql = ParameterizedOutputVisitorUtils.parameterize(sql, dbType, outParameters);</span><br><span class="line">assertEquals(<span class="string">"SELECT *\n"</span> +</span><br><span class="line">        <span class="string">"FROM t\n"</span> +</span><br><span class="line">        <span class="string">"WHERE id = ?\n"</span> +</span><br><span class="line">        <span class="string">"\tAND age = ?\n"</span> +</span><br><span class="line">        <span class="string">"\tOR name = ?"</span>, psql);</span><br><span class="line"></span><br><span class="line">assertEquals(<span class="number">3</span>, outParameters.size());</span><br><span class="line">assertEquals(<span class="number">101</span>, outParameters.get(<span class="number">0</span>));</span><br><span class="line">assertEquals(<span class="number">102</span>, outParameters.get(<span class="number">1</span>));</span><br><span class="line">assertEquals(<span class="string">"wenshao"</span>, outParameters.get(<span class="number">2</span>));</span><br></pre></td></tr></table></figure><h2 id="5-Druid-SQL-AST"><a href="#5-Druid-SQL-AST" class="headerlink" title="5. Druid SQL AST"></a>5. Druid SQL AST</h2><h3 id="1-ä»€ä¹ˆæ˜¯AST"><a href="#1-ä»€ä¹ˆæ˜¯AST" class="headerlink" title="1. ä»€ä¹ˆæ˜¯AST"></a>1. ä»€ä¹ˆæ˜¯AST</h3><p>ASTæ˜¯abstract syntax treeçš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯æŠ½è±¡è¯­æ³•æ ‘ã€‚å’Œæ‰€æœ‰çš„Parserä¸€æ ·ï¼ŒDruid Parserä¼šç”Ÿæˆä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘ã€‚</p><h3 id="2-åœ¨Druid-SQL-Parserä¸­æœ‰å“ªäº›ASTèŠ‚ç‚¹ç±»å‹"><a href="#2-åœ¨Druid-SQL-Parserä¸­æœ‰å“ªäº›ASTèŠ‚ç‚¹ç±»å‹" class="headerlink" title="2. åœ¨Druid SQL Parserä¸­æœ‰å“ªäº›ASTèŠ‚ç‚¹ç±»å‹"></a>2. åœ¨Druid SQL Parserä¸­æœ‰å“ªäº›ASTèŠ‚ç‚¹ç±»å‹</h3><p>åœ¨Druidä¸­ï¼ŒASTèŠ‚ç‚¹ç±»å‹ä¸»è¦åŒ…æ‹¬SQLObjectã€SQLExprã€SQLStatementä¸‰ç§æŠ½è±¡ç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.druid.sql.ast;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SQLObject</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SQLExpr</span> <span class="keyword">extends</span> <span class="title">SQLObject</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SQLStatement</span> <span class="keyword">extends</span> <span class="title">SQLObject</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SQLTableSource</span> <span class="keyword">extends</span> <span class="title">SQLObject</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLSelect</span> <span class="keyword">extends</span> <span class="title">SQLObject</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLSelectQueryBlock</span> <span class="keyword">extends</span> <span class="title">SQLObject</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><h4 id="2-1-å¸¸ç”¨çš„SQLExpræœ‰å“ªäº›"><a href="#2-1-å¸¸ç”¨çš„SQLExpræœ‰å“ªäº›" class="headerlink" title="2.1. å¸¸ç”¨çš„SQLExpræœ‰å“ªäº›"></a>2.1. å¸¸ç”¨çš„SQLExpræœ‰å“ªäº›</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.druid.sql.ast.expr;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SQLNameæ˜¯ä¸€ç§çš„SQLExprçš„Exprï¼ŒåŒ…æ‹¬SQLIdentifierExprã€SQLPropertyExprç­‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SQLName</span> <span class="keyword">extends</span> <span class="title">SQLExpr</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ ID = 3 è¿™é‡Œçš„IDæ˜¯ä¸€ä¸ªSQLIdentifierExpr</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLIdentifierExpr</span> <span class="keyword">implements</span> <span class="title">SQLExpr</span>, <span class="title">SQLName</span> </span>&#123;</span><br><span class="line">    String name;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ A.ID = 3 è¿™é‡Œçš„A.IDæ˜¯ä¸€ä¸ªSQLPropertyExpr</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLPropertyExpr</span> <span class="keyword">implements</span> <span class="title">SQLExpr</span>, <span class="title">SQLName</span> </span>&#123;</span><br><span class="line">    SQLExpr owner;</span><br><span class="line">    String name;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ ID = 3 è¿™æ˜¯ä¸€ä¸ªSQLBinaryOpExpr</span></span><br><span class="line"><span class="comment">// leftæ˜¯ID (SQLIdentifierExpr)</span></span><br><span class="line"><span class="comment">// rightæ˜¯3 (SQLIntegerExpr)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLBinaryOpExpr</span> <span class="keyword">implements</span> <span class="title">SQLExpr</span> </span>&#123;</span><br><span class="line">    SQLExpr left;</span><br><span class="line">    SQLExpr right;</span><br><span class="line">    SQLBinaryOperator operator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ select * from where id = ?ï¼Œè¿™é‡Œçš„?æ˜¯ä¸€ä¸ªSQLVariantRefExprï¼Œnameæ˜¯'?'</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLVariantRefExpr</span> <span class="keyword">extends</span> <span class="title">SQLExprImpl</span> </span>&#123; </span><br><span class="line">    String name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ ID = 3 è¿™é‡Œçš„3æ˜¯ä¸€ä¸ªSQLIntegerExpr</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SQLIntegerExpr</span> <span class="keyword">extends</span> <span class="title">SQLNumericLiteralExpr</span> <span class="keyword">implements</span> <span class="title">SQLValuableExpr</span> </span>&#123; </span><br><span class="line">    Number number;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰€æœ‰å®ç°äº†SQLValuableExpræ¥å£çš„SQLExpréƒ½å¯ä»¥ç›´æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ±‚å€¼</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.number;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ NAME = 'jobs' è¿™é‡Œçš„'jobs'æ˜¯ä¸€ä¸ªSQLCharExpr</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SQLCharExpr</span> <span class="keyword">extends</span> <span class="title">SQLTextLiteralExpr</span> <span class="keyword">implements</span> <span class="title">SQLValuableExpr</span></span>&#123;</span><br><span class="line">    String text;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-å¸¸ç”¨çš„SQLStatemment"><a href="#2-2-å¸¸ç”¨çš„SQLStatemment" class="headerlink" title="2.2. å¸¸ç”¨çš„SQLStatemment"></a>2.2. å¸¸ç”¨çš„SQLStatemment</h4><p>æœ€å¸¸ç”¨çš„Statementå½“ç„¶æ˜¯SELECT/UPDATE/DELETE/INSERTï¼Œä»–ä»¬åˆ†åˆ«æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.druid.sql.ast.statement;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLSelectStatement</span> <span class="keyword">implements</span> <span class="title">SQLStatement</span> </span>&#123;</span><br><span class="line">    SQLSelect select;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLUpdateStatement</span> <span class="keyword">implements</span> <span class="title">SQLStatement</span> </span>&#123;</span><br><span class="line">    SQLExprTableSource tableSource;</span><br><span class="line">     List&lt;SQLUpdateSetItem&gt; items;</span><br><span class="line">     SQLExpr where;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLDeleteStatement</span> <span class="keyword">implements</span> <span class="title">SQLStatement</span> </span>&#123;</span><br><span class="line">    SQLTableSource tableSource; </span><br><span class="line">    SQLExpr where;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLInsertStatement</span> <span class="keyword">implements</span> <span class="title">SQLStatement</span> </span>&#123;</span><br><span class="line">    SQLExprTableSource tableSource;</span><br><span class="line">    List&lt;SQLExpr&gt; columns;</span><br><span class="line">    SQLSelect query;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-SQLTableSource"><a href="#2-3-SQLTableSource" class="headerlink" title="2.3. SQLTableSource"></a>2.3. SQLTableSource</h4><p>å¸¸è§çš„SQLTableSourceåŒ…æ‹¬SQLExprTableSourceã€SQLJoinTableSourceã€SQLSubqueryTableSourceã€SQLWithSubqueryClause.Entry</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLTableSourceImpl</span> <span class="keyword">extends</span> <span class="title">SQLObjectImpl</span> <span class="keyword">implements</span> <span class="title">SQLTableSource</span> </span>&#123; </span><br><span class="line">    String alias;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ select * from emp where i = 3ï¼Œè¿™é‡Œçš„from empæ˜¯ä¸€ä¸ªSQLExprTableSource</span></span><br><span class="line"><span class="comment">// å…¶ä¸­expræ˜¯ä¸€ä¸ªname=empçš„SQLIdentifierExpr</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLExprTableSource</span> <span class="keyword">extends</span> <span class="title">SQLTableSourceImpl</span> </span>&#123;</span><br><span class="line">    SQLExpr expr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ select * from emp e inner join org o on e.org_id = o.id</span></span><br><span class="line"><span class="comment">// å…¶ä¸­left 'emp e' æ˜¯ä¸€ä¸ªSQLExprTableSourceï¼Œright 'org o'ä¹Ÿæ˜¯ä¸€ä¸ªSQLExprTableSource</span></span><br><span class="line"><span class="comment">// condition 'e.org_id = o.id'æ˜¯ä¸€ä¸ªSQLBinaryOpExpr</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLJoinTableSource</span> <span class="keyword">extends</span> <span class="title">SQLTableSourceImpl</span> </span>&#123;</span><br><span class="line">    SQLTableSource left;</span><br><span class="line">    SQLTableSource right;</span><br><span class="line">    JoinType joinType; <span class="comment">// INNER_JOIN/CROSS_JOIN/LEFT_OUTER_JOIN/RIGHT_OUTER_JOIN/...</span></span><br><span class="line">    SQLExpr condition;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ select * from (select * from temp) aï¼Œè¿™é‡Œç¬¬ä¸€å±‚from(...)æ˜¯ä¸€ä¸ªSQLSubqueryTableSource</span></span><br><span class="line">SQLSubqueryTableSource extends SQLTableSourceImpl &#123;</span><br><span class="line">    SQLSelect select;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">ä¾‹å¦‚</span></span><br><span class="line"><span class="comment">WITH RECURSIVE ancestors AS (</span></span><br><span class="line"><span class="comment">    SELECT *</span></span><br><span class="line"><span class="comment">    FROM org</span></span><br><span class="line"><span class="comment">    UNION</span></span><br><span class="line"><span class="comment">    SELECT f.*</span></span><br><span class="line"><span class="comment">    FROM org f, ancestors a</span></span><br><span class="line"><span class="comment">    WHERE f.id = a.parent_id</span></span><br><span class="line"><span class="comment">)</span></span><br><span class="line"><span class="comment">SELECT *</span></span><br><span class="line"><span class="comment">FROM ancestors;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">è¿™é‡Œçš„ancestors AS (...) æ˜¯ä¸€ä¸ªSQLWithSubqueryClause.Entry</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLWithSubqueryClause</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">SQLTableSourceImpl</span> </span>&#123; </span><br><span class="line">         SQLSelect subQuery;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-SQLSelect-amp-SQLSelectQuery"><a href="#2-4-SQLSelect-amp-SQLSelectQuery" class="headerlink" title="2.4. SQLSelect &amp; SQLSelectQuery"></a>2.4. SQLSelect &amp; SQLSelectQuery</h4><p>SQLSelectStatementåŒ…å«ä¸€ä¸ªSQLSelectï¼ŒSQLSelectåŒ…å«ä¸€ä¸ªSQLSelectQueryï¼Œéƒ½æ˜¯ç»„æˆçš„å…³ç³»ã€‚SQLSelectQueryæœ‰ä¸»è¦çš„ä¸¤ä¸ªæ´¾ç”Ÿç±»ï¼Œåˆ†åˆ«æ˜¯SQLSelectQueryBlockå’ŒSQLUnionQueryã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLSelect</span> <span class="keyword">extends</span> <span class="title">SQLObjectImpl</span> </span>&#123; </span><br><span class="line">    SQLWithSubqueryClause withSubQuery;</span><br><span class="line">    SQLSelectQuery query;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SQLSelectQuery</span> <span class="keyword">extends</span> <span class="title">SQLObject</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLSelectQueryBlock</span> <span class="keyword">implements</span> <span class="title">SQLSelectQuery</span> </span>&#123;</span><br><span class="line">    List&lt;SQLSelectItem&gt; selectList;</span><br><span class="line">    SQLTableSource from;</span><br><span class="line">    SQLExprTableSource into;</span><br><span class="line">    SQLExpr where;</span><br><span class="line">    SQLSelectGroupByClause groupBy;</span><br><span class="line">    SQLOrderBy orderBy;</span><br><span class="line">    SQLLimit limit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SQLUnionQuery</span> <span class="keyword">implements</span> <span class="title">SQLSelectQuery</span> </span>&#123;</span><br><span class="line">    SQLSelectQuery left;</span><br><span class="line">    SQLSelectQuery right;</span><br><span class="line">    SQLUnionOperator operator; <span class="comment">// UNION/UNION_ALL/MINUS/INTERSECT</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-5-SQLCreateTableStatement"><a href="#2-5-SQLCreateTableStatement" class="headerlink" title="2.5. SQLCreateTableStatement"></a>2.5. SQLCreateTableStatement</h4><p>å»ºè¡¨è¯­å¥åŒ…å«äº†ä¸€ç³»åˆ—æ–¹æ³•ï¼Œç”¨äºæ–¹ä¾¿å„ç§æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SQLCreateTableStatement</span> <span class="keyword">extends</span> <span class="title">SQLStatementImpl</span> <span class="keyword">implements</span> <span class="title">SQLDDLStatement</span>, <span class="title">SQLCreateStatement</span> </span>&#123;</span><br><span class="line">    SQLExprTableSource tableSource;</span><br><span class="line">    List&lt;SQLTableElement&gt; tableElementList;</span><br><span class="line">    Select select;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¿½ç•¥å¤§å°å†™çš„æŸ¥æ‰¾SQLCreateTableStatementä¸­çš„SQLColumnDefinition</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SQLColumnDefinition <span class="title">findColumn</span><span class="params">(String columName)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¿½ç•¥å¤§å°å†™çš„æŸ¥æ‰¾SQLCreateTableStatementä¸­çš„columnå…³è”çš„ç´¢å¼•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SQLTableElement <span class="title">findIndex</span><span class="params">(String columnName)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦å¤–é”®ä¾èµ–å¦å¤–ä¸€ä¸ªè¡¨</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReferenced</span><span class="params">(String tableName)</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-æ€æ ·äº§ç”ŸAST"><a href="#3-æ€æ ·äº§ç”ŸAST" class="headerlink" title="3. æ€æ ·äº§ç”ŸAST"></a>3. æ€æ ·äº§ç”ŸAST</h3><h4 id="3-1-é€šè¿‡SQLUtilsäº§ç”ŸList-lt-SQLStatement-gt"><a href="#3-1-é€šè¿‡SQLUtilsäº§ç”ŸList-lt-SQLStatement-gt" class="headerlink" title="3.1. é€šè¿‡SQLUtilsäº§ç”ŸList&lt;SQLStatement&gt;"></a>3.1. é€šè¿‡SQLUtilsäº§ç”ŸList&lt;SQLStatement&gt;</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.druid.util.JdbcConstants;</span><br><span class="line"></span><br><span class="line">String dbType = JdbcConstants.MYSQL;</span><br><span class="line">List&lt;SQLStatement&gt; statementList = SQLUtils.parseStatements(sql, dbType);</span><br></pre></td></tr></table></figure><h4 id="3-2-é€šè¿‡SQLUtilsäº§ç”ŸSQLExpr"><a href="#3-2-é€šè¿‡SQLUtilsäº§ç”ŸSQLExpr" class="headerlink" title="3.2. é€šè¿‡SQLUtilsäº§ç”ŸSQLExpr"></a>3.2. é€šè¿‡SQLUtilsäº§ç”ŸSQLExpr</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String dbType = JdbcConstants.MYSQL;</span><br><span class="line">SQLExpr expr = SQLUtils.toSQLExpr(<span class="string">"id=3"</span>, dbType);</span><br></pre></td></tr></table></figure><h3 id="4-æ€æ ·æ‰“å°ASTèŠ‚ç‚¹"><a href="#4-æ€æ ·æ‰“å°ASTèŠ‚ç‚¹" class="headerlink" title="4. æ€æ ·æ‰“å°ASTèŠ‚ç‚¹"></a>4. æ€æ ·æ‰“å°ASTèŠ‚ç‚¹</h3><h4 id="4-1-é€šè¿‡SQLUtilså·¥å…·ç±»æ‰“å°èŠ‚ç‚¹"><a href="#4-1-é€šè¿‡SQLUtilså·¥å…·ç±»æ‰“å°èŠ‚ç‚¹" class="headerlink" title="4.1. é€šè¿‡SQLUtilså·¥å…·ç±»æ‰“å°èŠ‚ç‚¹"></a>4.1. é€šè¿‡SQLUtilså·¥å…·ç±»æ‰“å°èŠ‚ç‚¹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.druid.sql;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SQLUtils</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¯ä»¥å°†SQLExpr/SQLStatementæ‰“å°ä¸ºStringç±»å‹</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">toSQLString</span><span class="params">(SQLObject sqlObj, String dbType)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯ä»¥å°†ä¸€ä¸ª&amp;lt;SQLStatement&amp;gt;æ‰“å°ä¸ºStringç±»å‹</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">toSQLString</span><span class="params">(List&lt;SQLStatement&gt; statementList, String dbType)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-å¦‚ä½•è‡ªå®šä¹‰éå†ASTèŠ‚ç‚¹"><a href="#5-å¦‚ä½•è‡ªå®šä¹‰éå†ASTèŠ‚ç‚¹" class="headerlink" title="5. å¦‚ä½•è‡ªå®šä¹‰éå†ASTèŠ‚ç‚¹"></a>5. å¦‚ä½•è‡ªå®šä¹‰éå†ASTèŠ‚ç‚¹</h3><p>æ‰€æœ‰çš„ASTèŠ‚ç‚¹éƒ½æ”¯æŒVisitoræ¨¡å¼ï¼Œéœ€è¦è‡ªå®šä¹‰éå†é€»è¾‘ï¼Œå¯ä»¥å®ç°ç›¸åº”çš„ASTVisitorAdapteræ´¾ç”Ÿç±»ï¼Œæ¯”å¦‚ <a href="https://github.com/alibaba/druid/wiki/SQL_Parser_Demo_visitor" target="_blank" rel="noopener">https://github.com/alibaba/druid/wiki/SQL_Parser_Demo_visitor</a></p><h3 id="6-ç›¸å…³é˜…è¯»"><a href="#6-ç›¸å…³é˜…è¯»" class="headerlink" title="6. ç›¸å…³é˜…è¯»"></a>6. ç›¸å…³é˜…è¯»</h3><ul><li><a href="https://github.com/alibaba/druid/wiki/SQL-Parser" target="_blank" rel="noopener">https://github.com/alibaba/druid/wiki/SQL-Parser</a></li><li><a href="https://github.com/alibaba/druid/wiki/SQL_Schema_Repository" target="_blank" rel="noopener">https://github.com/alibaba/druid/wiki/SQL_Schema_Repository</a></li><li><a href="https://github.com/alibaba/druid/wiki/SQL_RemoveCondition_demo" target="_blank" rel="noopener">https://github.com/alibaba/druid/wiki/SQL_RemoveCondition_demo</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> SQL </tag>
            
            <tag> Druid </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zookeeper å…¥é—¨</title>
      <link href="/posts/a097aeed/"/>
      <url>/posts/a097aeed/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨ä½¿ç”¨kafkaï¼ŒHbaseç­‰å¤§æ•°æ®ç»„ä»¶æ—¶ï¼Œå‘ç°å¾ˆå¤šå¼€æºé¡¹ç›®éƒ½ç”¨åˆ°äº†Zookeeperã€‚æ‰€ä»¥åœ¨è¿™é‡Œç®€å•ç ”ç©¶ä¸€ä¸‹Zookeeper</p><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><h2 id="Zookeeper-æ˜¯ä»€ä¹ˆ"><a href="#Zookeeper-æ˜¯ä»€ä¹ˆ" class="headerlink" title="Zookeeper æ˜¯ä»€ä¹ˆ"></a>Zookeeper æ˜¯ä»€ä¹ˆ</h2><p>Zookeeperæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼åè°ƒæ¡†æ¶ï¼Œå®ç°åŒæ­¥æœåŠ¡ï¼Œé…ç½®ç»´æŠ¤å’Œå‘½åæœåŠ¡ç­‰åˆ†å¸ƒå¼åº”ç”¨ã€‚æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ</p><h2 id="Zookeeper-èƒ½å¹²ä»€ä¹ˆ"><a href="#Zookeeper-èƒ½å¹²ä»€ä¹ˆ" class="headerlink" title="Zookeeper èƒ½å¹²ä»€ä¹ˆ"></a>Zookeeper èƒ½å¹²ä»€ä¹ˆ</h2><p>å¯ä»¥åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å…±äº«é…ç½®ï¼Œåè°ƒé”èµ„æºï¼Œæä¾›å‘½åæœåŠ¡</p><ol><li>åˆ†å¸ƒå¼é”ï¼šåˆ©ç”¨Zookeeperçš„ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Œå¯ä»¥è½»æ¾å®ç°åˆ†å¸ƒå¼é”</li><li>æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼š åˆ©ç”¨Znodeå’ŒWatcherï¼Œå¯ä»¥å®ç°åˆ†å¸ƒå¼æœåŠ¡çš„æ³¨å†Œä¸å‘ç°ã€‚å¦‚ï¼šDubbo</li><li>å…±äº«é…ç½®ä¸çŠ¶æ€ä¿¡æ¯ï¼šå¦‚Redisçš„åˆ†å¸ƒå¼Codisï¼Œåˆ©ç”¨Zookeeperå­˜æ”¾æ•°æ®è·¯ç”±è¡¨å’Œcodis-proxyèŠ‚ç‚¹çš„å…ƒä¿¡æ¯ï¼ŒåŒæ—¶codis-configå‘èµ·çš„å‘½ä»¤éƒ½ä¼šé€šè¿‡ZookeeperåŒæ­¥åˆ°å„ä¸ªå­˜æ´»çš„codis-proxyã€‚</li></ol><h3 id="Zookeeper-çš„æ•°æ®æ¨¡å‹"><a href="#Zookeeper-çš„æ•°æ®æ¨¡å‹" class="headerlink" title="Zookeeper çš„æ•°æ®æ¨¡å‹"></a>Zookeeper çš„æ•°æ®æ¨¡å‹</h3><p>Zookeeperçš„æ•°æ®æ¨¡å‹ç±»ä¼¼äºæ•°æ®ç»“æ„ä¸­çš„æ ‘ï¼Œä¹Ÿç±»ä¼¼äºLinuxæ–‡ä»¶ç³»ç»Ÿä¸­çš„ç›®å½•</p><p>æ ‘ç”±å¤šä¸ªèŠ‚ç‚¹æ„æˆï¼ŒZookeeperçš„æ•°æ®å­˜å‚¨åŒæ ·åŸºäºèŠ‚ç‚¹ã€‚åœ¨ Zookeeper ä¸­ï¼Œè¿™æ ·çš„èŠ‚ç‚¹è¢«ç§°ä½œä¸º Znode</p><p>Zookeeperçš„å¼•ç”¨æ–¹å¼æ˜¯è·¯å¾„å¼•ç”¨ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/tree1/node1</span><br><span class="line">/tree2/node2</span><br></pre></td></tr></table></figure><p>è¿™ç§å±‚çº§ç»“æ„å¯ä»¥è®©æ¯ä¸€ä¸ªZnodeèŠ‚ç‚¹æ‹¥æœ‰å”¯ä¸€çš„è·¯å¾„ï¼Œå¯ä»¥å¯¹ä¸åŒä¿¡æ¯åšå‡ºæ¸…æ™°çš„éš”ç¦»</p><h3 id="Znode-é‡Œæœ‰ä»€ä¹ˆï¼Ÿ"><a href="#Znode-é‡Œæœ‰ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Znode é‡Œæœ‰ä»€ä¹ˆï¼Ÿ"></a>Znode é‡Œæœ‰ä»€ä¹ˆï¼Ÿ</h3><p>ZnodeåŒ…å«äº†æ•°æ®ï¼Œå­èŠ‚ç‚¹å¼•ç”¨ï¼Œè®¿é—®æƒé™ç­‰æ•°æ®ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">|         data           |  ACL  |</span><br><span class="line">---------------------------------</span><br><span class="line">|child (znode1,znode2...)|  stat |</span><br><span class="line"></span><br><span class="line">data è´Ÿè´£å­˜å‚¨Znodeå­˜å‚¨çš„æ•°æ®ä¿¡æ¯</span><br><span class="line">ACL  è®°å½•Znodeçš„è®¿é—®æƒé™ï¼Œè°å¯ä»¥è®¿é—®æœ¬èŠ‚ç‚¹</span><br><span class="line">stat åŒ…å«Znodeçš„å„ç§å…ƒæ•°æ®ï¼Œå¦‚ï¼šäº‹åŠ¡IDã€ç‰ˆæœ¬å·ã€æ—¶é—´æˆ³ã€å¤§å° ç­‰</span><br><span class="line">childå½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å¼•ç”¨ï¼Œç±»ä¼¼äºäºŒå‰æ ‘çš„å·¦å³å­©å­</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯Zookeeperæ˜¯ä¸ºäº†è¯»å¤šå†™å°‘çš„åœºæ™¯æ‰€è®¾è®¡ï¼ŒZnodeå¹¶éæ˜¯ç”¨æ¥å­˜å‚¨å¤§è§„æ¨¡ä¸šåŠ¡æ•°æ®ï¼Œè€Œæ˜¯ç”¨äºå­˜å‚¨å°‘é‡çš„çŠ¶æ€ä¸é…ç½®ä¿¡æ¯ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®æœ€å¤§ä¸èƒ½è¶…è¿‡ 1MBï¼</p><h2 id="Zookeeper-è¿è¡ŒåŸç†æ˜¯ä»€ä¹ˆ"><a href="#Zookeeper-è¿è¡ŒåŸç†æ˜¯ä»€ä¹ˆ" class="headerlink" title="Zookeeper è¿è¡ŒåŸç†æ˜¯ä»€ä¹ˆ"></a>Zookeeper è¿è¡ŒåŸç†æ˜¯ä»€ä¹ˆ</h2><h3 id="ä»€ä¹ˆæ˜¯Watchï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯Watchï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯Watchï¼Ÿ"></a>ä»€ä¹ˆæ˜¯Watchï¼Ÿ</h3><p>å¯ä»¥ç†è§£ä¸ºæ³¨å†Œåœ¨ç‰¹å®šZnodeä¸Šçš„è§¦å‘å™¨ï¼Œå½“è¿™ä¸ªZnodeå‘ç”Ÿæ”¹å˜ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†create,delete,setDataæ–¹æ³•çš„æ—¶å€™ï¼Œå°†ä¼šè§¦å‘Znodeä¸Šæ³¨å†Œçš„å¯¹åº”äº‹ä»¶ï¼Œè¯·æ±‚Watchçš„å®¢æˆ·ç«¯å°†ä¼šæ”¶åˆ°å¼‚æ­¥é€šçŸ¥</p><h4 id="Watchçš„äº¤äº’è¿‡ç¨‹"><a href="#Watchçš„äº¤äº’è¿‡ç¨‹" class="headerlink" title="Watchçš„äº¤äº’è¿‡ç¨‹"></a>Watchçš„äº¤äº’è¿‡ç¨‹</h4><p>è¿™é‡Œå€Ÿç”¨ç¨‹åºçŒ¿å°ç°åšæ–‡ä¸­çš„å›¾ï¼š</p><ol><li>å®¢æˆ·ç«¯è°ƒç”¨getDataæ–¹æ³•ï¼Œwatchå‚æ•°ä¸º true ã€‚æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚ï¼Œè¿”å›èŠ‚ç‚¹æ•°æ®ï¼Œå¹¶ä¸”åœ¨å¯¹åº”çš„å“ˆå¸Œè¡¨ä¸­æ’å…¥è¢«Watchçš„Znodeè·¯å¾„ã€‚ä»¥åŠWatcheråˆ—è¡¨ã€‚</li></ol><p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200804235728.jpeg" alt=""></p><ol start="2"><li>å½“è¢«watchçš„Znodeå·²åˆ é™¤ï¼ŒæœåŠ¡ç«¯ä¼šæŸ¥æ‰¾å“ˆå¸Œè¡¨ï¼Œæ‰¾åˆ°è¯¥Znodeå¯¹åº”çš„æ‰€æœ‰Watcherï¼Œå¼‚æ­¥é€šçŸ¥å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”åˆ é™¤hashè¡¨ä¸­å¯¹åº”çš„ K-V</li></ol><p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200804235659.jpeg" alt=""></p><h3 id="Zookeeper-çš„ä¸€è‡´æ€§"><a href="#Zookeeper-çš„ä¸€è‡´æ€§" class="headerlink" title="Zookeeper çš„ä¸€è‡´æ€§"></a>Zookeeper çš„ä¸€è‡´æ€§</h3><p>å¦‚æœZookeeperè‡ªèº«æŒ‚æ‰äº†ï¼Œå®ƒä½œä¸ºåˆ†å¸ƒå¼çš„åè°ƒæœåŠ¡ï¼Œåº”è¯¥æ€ä¹ˆåŠï¼Ÿ</p><p>ä¸ºäº†é˜²æ­¢Zookeeperå•æœºæŒ‚æ‰çš„æƒ…å†µï¼ŒZookeeperç»´æŠ¤äº†ä¸€ä¸ªé›†ç¾¤</p><p>è¿™é‡Œè¿˜æ˜¯å€Ÿç”¨å°ç°çš„å›¾ï¼š</p><p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200804235334.png" alt=""></p><p>ZookeeperæœåŠ¡çš„é›†ç¾¤æ˜¯ä¸€ä¸»å¤šä»çš„ç»“æ„ã€‚</p><p>åœ¨æ›´æ–°æ•°æ®æ—¶ï¼Œé¦–å…ˆæ›´æ–°åˆ°ä¸»èŠ‚ç‚¹ï¼ˆæœåŠ¡å™¨ï¼ŒéZnodeï¼‰ï¼Œå†åŒæ­¥åˆ°ä»èŠ‚ç‚¹ã€‚</p><p>åœ¨è¯»å–æ•°æ®æ—¶ï¼Œç›´æ¥è¯»å–ä»»æ„ä»èŠ‚ç‚¹</p><p>ä¸ºäº†ä¿è¯ä¸»ä»èŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´æ€§ï¼ŒZookeeperé‡‡ç”¨äº†è‡ªå·±çš„ZABåè®®ã€‚ç±»ä¼¼äºä¸€è‡´æ€§ç®—æ³•Paxosä¸Raft</p><p>ZABåè®®æ˜¯ï¼šZookeeper Atomic Broadcastã€‚ æœ‰æ•ˆè§£å†³Zookeeperçš„é›†ç¾¤å´©æºƒæ¢å¤ï¼Œä»¥åŠä¸»ä»åŒæ­¥æ•°æ®çš„é—®é¢˜ã€‚</p><h4 id="ZABåè®®"><a href="#ZABåè®®" class="headerlink" title="ZABåè®®"></a>ZABåè®®</h4><p>ZABåè®®å®šä¹‰äº†ä¸‰ç§èŠ‚ç‚¹çŠ¶æ€</p><ul><li>Lookingï¼šé€‰ä¸¾çŠ¶æ€</li><li>Followingï¼šä»èŠ‚ç‚¹æ‰€å¤„çš„çŠ¶æ€</li><li>Leadingï¼š LeaderèŠ‚ç‚¹æ‰€å¤„çš„çŠ¶æ€</li></ul><h4 id="æœ€å¤§ZXID"><a href="#æœ€å¤§ZXID" class="headerlink" title="æœ€å¤§ZXID"></a>æœ€å¤§ZXID</h4><p>æœ€å¤§ZXIDä¹Ÿå°±æ˜¯èŠ‚ç‚¹æœ¬åœ°çš„æœ€æ–°äº‹åŠ¡ç¼–å·ï¼ŒåŒ…å«epochä¸è®¡æ•°ä¸¤éƒ¨åˆ†ã€‚epochæ˜¯çºªå…ƒçš„æ„æ€ï¼Œç›¸å½“äºRaftç®—æ³•é€‰ä¸»æ—¶å€™çš„term</p><h4 id="Zookeeperé›†ç¾¤å´©æºƒæ¢å¤"><a href="#Zookeeperé›†ç¾¤å´©æºƒæ¢å¤" class="headerlink" title="Zookeeperé›†ç¾¤å´©æºƒæ¢å¤"></a>Zookeeperé›†ç¾¤å´©æºƒæ¢å¤</h4><p>å‡å¦‚Zookeeperå½“å‰ä¸»èŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œé›†ç¾¤ä¼šè¿›è¡Œå´©æºƒæ¢å¤ã€‚ZABçš„å´©æºƒæ¢å¤åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><ol><li>Leader election</li></ol><p>é€‰ä¸¾é˜¶æ®µï¼Œæ­¤æ—¶é›†ç¾¤ä¸­çš„èŠ‚ç‚¹å¤„äºLookingçŠ¶æ€ã€‚ä»–ä»¬ä¼šå„è‡ªå‘å…¶ä»–èŠ‚ç‚¹å‘èµ·æŠ•ç¥¨ï¼ŒæŠ•ç¥¨å½“ä¸­åŒ…å«è‡ªå·±çš„æœåŠ¡å™¨IDå’Œæœ€æ–°äº‹åŠ¡IDï¼ˆZXIDï¼‰</p><p>æ¥ä¸‹æ¥ï¼ŒèŠ‚ç‚¹ä¼šç”¨è‡ªèº«çš„ZXIDå’Œä»å…¶ä»–èŠ‚ç‚¹æ¥å—åˆ°çš„ZXIDåšæ¯”è¾ƒï¼Œå¦‚æœå‘ç°å…¶ä»–ç»“ç‚¹çš„ZXIDæ¯”è‡ªå·±å¤§ï¼Œä¹Ÿå°±æ˜¯æ•°æ®æ¯”è‡ªå·±æ–°ï¼Œé‚£ä¹ˆå°±é‡æ–°å‘èµ·æŠ•ç¥¨ï¼ŒæŠ•ç¥¨ç»™ç›®å‰å·²çŸ¥æœ€å¤§çš„ZXIDæ‰€å±èŠ‚ç‚¹</p><p>æ¯æ¬¡æŠ•ç¥¨åï¼ŒæœåŠ¡å™¨ä¼šç»Ÿè®¡æŠ•ç¥¨æ•°é‡ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æŸä¸ªèŠ‚ç‚¹è·å¾—åŠæ•°ä»¥ä¸Šçš„æŠ•ç¥¨ã€‚å¦‚æœå­˜åœ¨è¿™æ ·çš„èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹å°†ä¼šæˆä¸ºå‡†Leaderï¼ŒçŠ¶æ€å˜ä¸ºLeadingã€‚å…¶ä»–èŠ‚ç‚¹éšä¹‹å˜ä¸ºFollowingã€‚</p><ol start="2"><li>Discovery</li></ol><p>å‘ç°é˜¶æ®µï¼Œç”¨äºåœ¨ä»èŠ‚ç‚¹ä¸­å‘ç°æœ€æ–°çš„ZXIDä¸äº‹åŠ¡æ—¥å¿—ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢å› ä¸ºæŸäº›æ„å¤–æƒ…å†µï¼Œæ¯”å¦‚ç½‘ç»œåŸå› åœ¨ä¸Šä¸€é˜¶æ®µäº§ç”Ÿå¤šä¸ªLeaderçš„æƒ…å†µã€‚</p><p>æ‰€ä»¥åœ¨æ­¤é˜¶æ®µï¼ŒLeaderæ¥æ”¶æ‰€æœ‰Followerå‘æ¥å„è‡ªçš„æœ€æ–°epochå€¼ã€‚Leaderä»ä¸­é€‰å‡ºæœ€å¤§çš„epochï¼ŒåŸºäºæ­¤å€¼+1ï¼Œç”Ÿæˆæ–°çš„epochåˆ†å‘ç»™å„ä¸ªFollower</p><p>å„ä¸ªFollowäºŒæ”¶åˆ°å…¨æ–°çš„epochåï¼Œè¿”å›ACKç»™Leaderï¼Œå¸¦ä¸Šå„è‡ªæœ€å¤§çš„ZXIDå’Œå†å²äº‹åŠ¡æ—¥å¿—ã€‚Leaderé€‰å‡ºæœ€å¤§çš„ZXIDï¼Œå¹¶æ›´æ–°è‡ªèº«å†å²æ—¥å¿—ã€‚</p><ol start="3"><li>Synchronization</li></ol><p>åŒæ­¥é˜¶æ®µï¼ŒæŠŠLeaderåˆšæ‰æ”¶é›†åˆ°çš„æœ€æ–°å†å²äº‹åŠ¡æ—¥å¿—ï¼ŒåŒæ­¥ç»™é›†ç¾¤ä¸­æ‰€æœ‰çš„Followerã€‚åªæœ‰å½“åŠæ•°FolloweråŒæ­¥æˆåŠŸï¼Œè¿™ä¸ªå‡†Leaderæ‰èƒ½æˆä¸ºæ­£å¼Leader</p><p>æ•…éšœæ¢å¤ç»“æŸ</p><h4 id="ZABå¦‚ä½•å†™å…¥æ•°æ®ï¼Ÿ"><a href="#ZABå¦‚ä½•å†™å…¥æ•°æ®ï¼Ÿ" class="headerlink" title="ZABå¦‚ä½•å†™å…¥æ•°æ®ï¼Ÿ"></a>ZABå¦‚ä½•å†™å…¥æ•°æ®ï¼Ÿ</h4><p>åœ¨å†™å…¥è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°ZABåè®®çš„Broadcasté˜¶æ®µ</p><p>Broadcastæ˜¯Zookeeperå¸¸è§„æƒ…å†µä¸‹æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œç”±Leaderå¹¿æ’­åˆ°æ‰€æœ‰çš„Followerã€‚å…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>å®¢æˆ·ç«¯å‘å‡ºå†™å…¥æ•°æ®è¯·æ±‚ç»™ä»»æ„Follower</p></li><li><p>FolloweræŠŠå†™å…¥æ•°æ®è¯·æ±‚è½¬å‘ç»™Leader</p></li><li><p>Leaderé‡‡ç”¨äºŒé˜¶æ®µæäº¤æ–¹å¼ï¼Œå…ˆå‘é€Proposeå¹¿æ’­ç»™Followerã€‚</p></li><li><p>Followeræ¥åˆ°Proposeæ¶ˆæ¯ï¼Œå†™å…¥æ—¥å¿—æˆåŠŸåï¼Œè¿”å›ACKæ¶ˆæ¯ç»™leader</p></li><li><p>leaderæ¥åˆ°åŠæ•°ä»¥ä¸ŠACKæ¶ˆæ¯ï¼Œè¿”å›æˆåŠŸç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”å¹¿æ’­Commitè¯·æ±‚ç»™Follower</p></li></ol><p>ZABåè®®å¹¶éå¼ºä¸€è‡´æ€§ï¼Œä¹Ÿä¸æ˜¯å¼±ä¸€è‡´æ€§ï¼Œè€Œæ˜¯å¤„äºä¸¤è€…ä¹‹é—´çš„å•è°ƒä¸€è‡´æ€§ã€‚å®ƒä¾é äº‹åŠ¡IDå’Œç‰ˆæœ¬å·ï¼Œä¿è¯äº†æ•°æ®çš„æ›´æ–°å’Œè¯»å–æ˜¯æœ‰åºçš„ã€‚</p><h2 id="Zookeeper-æ€ä¹ˆä½¿ç”¨"><a href="#Zookeeper-æ€ä¹ˆä½¿ç”¨" class="headerlink" title="Zookeeper æ€ä¹ˆä½¿ç”¨"></a>Zookeeper æ€ä¹ˆä½¿ç”¨</h2><p>Zookeeper ä¸ºå¼€å‘è€…ä»¬æä¾›äº†ä¸€äº›ç®€å•çš„APIï¼Œç”šè‡³æä¾›äº†è§¦å‘å™¨æœºåˆ¶ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create åˆ›å»ºèŠ‚ç‚¹</span><br><span class="line">delete åˆ é™¤èŠ‚ç‚¹</span><br><span class="line">exist  åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼ˆè¯»æ“ä½œï¼‰</span><br><span class="line">getData è·å¾—ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®ï¼ˆè¯»æ“ä½œï¼‰</span><br><span class="line">setData è®¾ç½®ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®</span><br><span class="line">getChildren è·å–èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼ˆè¯»æ“ä½œï¼‰</span><br></pre></td></tr></table></figure><p>Zookeeperå®¢æˆ·ç«¯åœ¨è¯·æ±‚è¯»æ“ä½œçš„æ—¶å€™ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦è®¾ç½®Watch</p><h3 id="æ­å»º"><a href="#æ­å»º" class="headerlink" title="æ­å»º"></a>æ­å»º</h3><p>ä»å®˜æ–¹ç½‘ç«™ä¸‹è½½zookeeperçš„æœ€æ–°å®‰è£…åŒ…ï¼š<a href="https://zookeeper.apache.org/releases.html" target="_blank" rel="noopener">é“¾æ¥</a></p><h4 id="å•æœºç‰ˆ"><a href="#å•æœºç‰ˆ" class="headerlink" title="å•æœºç‰ˆ"></a>å•æœºç‰ˆ</h4><p>å•æœºç‰ˆå¾ˆç®€å•ï¼Œç›´æ¥è§£å‹zookeeperçš„å‹ç¼©åŒ…ï¼Œè¿›å…¥confç›®å½•ä¸‹ï¼Œå¤åˆ¶ä¸€ä»½zoo_sample.cfgæ–‡ä»¶åˆ°confç›®å½•ä¸‹å‘½åä¸ºzoo.cfg,æ ¹æ®è‡ªå·±çš„éœ€è¦ä¿®æ”¹é…ç½®å³å¯</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The number of milliseconds of each tick</span></span><br><span class="line"><span class="attr">tickTime</span>=<span class="string">2000</span></span><br><span class="line"><span class="comment"># The number of ticks that the initial </span></span><br><span class="line"><span class="comment"># synchronization phase can take</span></span><br><span class="line"><span class="attr">initLimit</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"># The number of ticks that can pass between </span></span><br><span class="line"><span class="comment"># sending a request and getting an acknowledgement</span></span><br><span class="line"><span class="attr">syncLimit</span>=<span class="string">5</span></span><br><span class="line"><span class="comment"># the directory where the snapshot is stored.</span></span><br><span class="line"><span class="comment"># do not use /tmp for storage, /tmp here is just </span></span><br><span class="line"><span class="comment"># example sakes.</span></span><br><span class="line"><span class="attr">dataDir</span>=<span class="string">/tmp/zookeeper</span></span><br><span class="line"><span class="comment"># the port at which the clients will connect</span></span><br><span class="line"><span class="attr">clientPort</span>=<span class="string">2181</span></span><br><span class="line"><span class="comment"># the maximum number of client connections.</span></span><br><span class="line"><span class="comment"># increase this if you need to handle more clients</span></span><br><span class="line"><span class="comment">#maxClientCnxns=60</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Be sure to read the maintenance section of the </span></span><br><span class="line"><span class="comment"># administrator guide before turning on autopurge.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The number of snapshots to retain in dataDir</span></span><br><span class="line"><span class="comment">#autopurge.snapRetainCount=3</span></span><br><span class="line"><span class="comment"># Purge task interval in hours</span></span><br><span class="line"><span class="comment"># Set to "0" to disable auto purge feature</span></span><br><span class="line"><span class="comment">#autopurge.purgeInterval=1</span></span><br></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œbinç›®å½•ä¸‹çš„zkServer.shå³å¯å¯åŠ¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon bin]# zkServer.sh start</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /opt/apache-zookeeper-3.5.7-bin/bin/../conf/zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br></pre></td></tr></table></figure><h4 id="é›†ç¾¤æ­å»º"><a href="#é›†ç¾¤æ­å»º" class="headerlink" title="é›†ç¾¤æ­å»º"></a>é›†ç¾¤æ­å»º</h4><p>é›†ç¾¤æ­å»ºä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨ä¸Šè¿°çš„zoo.cfgæ–‡ä»¶ä¸­åŠ å…¥ä¸€ä¸‹é…ç½®</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.zk1</span>=<span class="string">xxx.xxx.x.xx:2888:3888</span></span><br><span class="line"><span class="meta">server.zk2</span>=<span class="string">xxx.xxx.x.xx:2888:3888</span></span><br><span class="line"><span class="meta">server.zk3</span>=<span class="string">xxx.xxx.x.xx:2888:3888</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­2888ä¸ºé€šä¿¡ç«¯å£å·ï¼Œ3888ä¸ºé€‰ä¸¾ç«¯å£å·</p><p>ç„¶ååˆ†åˆ«å¯åŠ¨ä¸‰å°Zookeeperçš„æœåŠ¡å³å¯</p>]]></content>
      
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Zookeeper </tag>
            
            <tag> åˆ†å¸ƒå¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java ç½‘ç»œç¼–ç¨‹ä¹‹ SSLåŠ å¯†è¿æ¥</title>
      <link href="/posts/8662ab0e/"/>
      <url>/posts/8662ab0e/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å…³äºSSLåŠ å¯†è¿æ¥æ–¹å¼çš„ä¸€åˆ‡åœ¨è¿™é‡Œå°±ä¸å†èµ˜è¿°ï¼Œè¿™é‡Œä¸»è¦åˆ†äº«å…³äºåœ¨Javaç¼–ç¨‹ä¸­å¦‚ä½•å¯¹SSLè¿›è¡Œç¼–ç </p><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><h2 id="å‡ ä¸ªé‡è¦çš„ç±»"><a href="#å‡ ä¸ªé‡è¦çš„ç±»" class="headerlink" title="å‡ ä¸ªé‡è¦çš„ç±»"></a>å‡ ä¸ªé‡è¦çš„ç±»</h2><h3 id="KeyStore"><a href="#KeyStore" class="headerlink" title="KeyStore"></a>KeyStore</h3><p>è¡¨ç¤ºå¯†é’¥å’Œè¯ä¹¦çš„å­˜å‚¨è®¾æ–½</p><p>ä¸»è¦ç”¨äºå­˜æ”¾è¯ä¹¦ï¼Œåˆ›å»ºå¯¹è±¡æ—¶ï¼ŒæŒ‡å®šäº¤æ¢æ•°å­—è¯ä¹¦çš„åŠ å¯†æ ‡å‡†</p><p>ç”¨æ³•å¦‚ä¸‹(ä»¥pkcs12ä¸ºä¾‹)ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">InputStream stream=<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> Filel(<span class="string">"your file path"</span>));</span><br><span class="line"><span class="keyword">char</span>[] password=<span class="string">"your password"</span>.toCharArray();</span><br><span class="line">KeyStore keyStore=KeyStore.getInstance(<span class="string">"PKCS12"</span>);</span><br><span class="line">keyStore.load(stream, password);</span><br><span class="line">stream.close();</span><br></pre></td></tr></table></figure><h3 id="KeyManager"><a href="#KeyManager" class="headerlink" title="KeyManager"></a>KeyManager</h3><p>é€‰æ‹©è¯ä¹¦æ¥è¯æ˜è‡ªå·±çš„èº«ä»½</p><p>è¿™æ˜¯ç”¨äº JSSE å¯†é’¥ç®¡ç†å™¨çš„åŸºæ¥å£ã€‚</p><p>KeyManager è´Ÿè´£ç®¡ç†ç”¨äºéªŒè¯åˆ°åŒä½ä½“çš„æœ¬åœ° SSLSocket çš„å¯†é’¥å†…å®¹ã€‚å¦‚æœæ²¡æœ‰å¯†é’¥å†…å®¹å¯ä»¥ä½¿ç”¨ï¼Œåˆ™å¥—æ¥å­—å°†ä¸èƒ½æä¾›éªŒè¯è¯ä¹¦ã€‚</p><p>é€šè¿‡ä½¿ç”¨ KeyManagerFactoryï¼Œæˆ–å®ç° KeyManager å­ç±»ä¹‹ä¸€æ¥åˆ›å»º KeyManagerã€‚</p><p>ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œçš„ keyStoreã€password å¯ä»¥å‚è€ƒä¸Šæ–¹ä»£ç </span></span><br><span class="line">KeyManagerFactory keyManagerFactory=KeyManagerFactory.getInstance(<span class="string">"PKCS12"</span>);</span><br><span class="line">keyManagerFactory.init(keyStore,password);</span><br><span class="line">KeyManager[] keyManagers=keyManagerFactory.getKeyManagers();</span><br></pre></td></tr></table></figure><h3 id="TrustManager"><a href="#TrustManager" class="headerlink" title="TrustManager"></a>TrustManager</h3><p>å†³å®šæ˜¯å¦ä¿¡ä»»å¯¹æ–¹çš„è¯ä¹¦</p><p>è¿™æ˜¯ç”¨äº JSSE ä¿¡ä»»ç®¡ç†å™¨çš„åŸºæ¥å£ã€‚</p><p>TrustManager è´Ÿè´£ç®¡ç†åšå‡ºä¿¡ä»»å†³å®šæ—¶ä½¿ç”¨çš„çš„ä¿¡ä»»ææ–™ï¼Œä¹Ÿè´Ÿè´£å†³å®šæ˜¯å¦æ¥å—åŒä½ä½“æä¾›çš„è¯ä¹¦ã€‚</p><p>é€šè¿‡ä½¿ç”¨ TrustManagerFactoryï¼Œæˆ–å®ç° TrustManager å­ç±»ä¹‹ä¸€åˆ›å»º TrustManagerã€‚</p><p>ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œçš„ keyStore å¯ä»¥å‚è€ƒä¸Šæ–¹ä»£ç </span></span><br><span class="line">TrustManagerFactory trustManagerFactory=TrustManagerFactory.getInstance(<span class="string">"PKCS12"</span>);</span><br><span class="line">trustManagerFactory.init(keyStore);</span><br><span class="line">TrustManager[] trustManagers=trustManagerFactory.getTrustManagers();</span><br></pre></td></tr></table></figure><h3 id="SSLContext"><a href="#SSLContext" class="headerlink" title="SSLContext"></a>SSLContext</h3><p>æ­¤ç±»çš„å®ä¾‹è¡¨ç¤ºå®‰å…¨å¥—æ¥å­—åè®®çš„å®ç°ï¼Œå®ƒå……å½“ç”¨äºå®‰å…¨å¥—æ¥å­—å·¥å‚æˆ– SSLEngine çš„å·¥å‚ã€‚ç”¨å¯é€‰çš„ä¸€ç»„å¯†é’¥å’Œä¿¡ä»»ç®¡ç†å™¨åŠå®‰å…¨éšæœºå­—èŠ‚æºåˆå§‹åŒ–æ­¤ç±»ã€‚</p><p>ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SSLContext context=SSLContext.getInstance(<span class="string">"SSL"</span>);</span><br><span class="line">context.init(keyManagers, trustManagers, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure><h3 id="SSLEngine"><a href="#SSLEngine" class="headerlink" title="SSLEngine"></a>SSLEngine</h3><p>æ•°æ®å‘é€å‰wrapæ‰“åŒ…åŠ å¯†ï¼Œæ•°æ®æ¥æ”¶æ—¶unwrapè§£åŒ…è§£å¯†ï¼Œè¿™æ ·ä¸€ä¸ªtcpæ•°æ®åŒ…é€šè¿‡SSLEngineçš„è¿‡ç¨‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆæ¥è‡ªJDKæºç ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">                app data</span><br><span class="line">             |           ^</span><br><span class="line">             |     |     |</span><br><span class="line">             v     |     |</span><br><span class="line">        +----+-----|-----+----+</span><br><span class="line">        |          |          |</span><br><span class="line">        |       SSL|Engine    |</span><br><span class="line">wrap()  |          |          |  unwrap()</span><br><span class="line">        | OUTBOUND | INBOUND  |</span><br><span class="line">        |          |          |</span><br><span class="line">        +----+-----|-----+----+</span><br><span class="line">             |     |     ^</span><br><span class="line">             |     |     |</span><br><span class="line">             v           |</span><br><span class="line">                net data</span><br></pre></td></tr></table></figure><p>ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­¤contextä¸ºä¸Šæ–‡æåˆ°çš„SSLContext</span></span><br><span class="line">SSLEngine engine = context.createSSLEngine();</span><br></pre></td></tr></table></figure><h2 id="è¯ä¹¦äº’ç›¸è½¬æ¢"><a href="#è¯ä¹¦äº’ç›¸è½¬æ¢" class="headerlink" title="è¯ä¹¦äº’ç›¸è½¬æ¢"></a>è¯ä¹¦äº’ç›¸è½¬æ¢</h2><h3 id="pemæ ¼å¼è¯ä¹¦è½¬ä¸ºpkcs12æ ¼å¼"><a href="#pemæ ¼å¼è¯ä¹¦è½¬ä¸ºpkcs12æ ¼å¼" class="headerlink" title="pemæ ¼å¼è¯ä¹¦è½¬ä¸ºpkcs12æ ¼å¼"></a>pemæ ¼å¼è¯ä¹¦è½¬ä¸ºpkcs12æ ¼å¼</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -export -in client.pem -out client.p12</span><br></pre></td></tr></table></figure><h3 id="pemæ ¼å¼è¯ä¹¦å¯¼å‡ºx509æ ¼å¼"><a href="#pemæ ¼å¼è¯ä¹¦å¯¼å‡ºx509æ ¼å¼" class="headerlink" title="pemæ ¼å¼è¯ä¹¦å¯¼å‡ºx509æ ¼å¼"></a>pemæ ¼å¼è¯ä¹¦å¯¼å‡ºx509æ ¼å¼</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -outform der -in client.pem -out client.crt</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java ç¼–ç¨‹ç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> SSL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB æŠ¥æ–‡è§£è¯»</title>
      <link href="/posts/c88df007/"/>
      <url>/posts/c88df007/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ç”±äºå·¥ä½œå’Œå­¦ä¹ çš„éœ€è¦ï¼Œéœ€è¦å¯¹ MongoDB çš„æŠ¥æ–‡è¿›è¡Œåˆ†æå’Œè§£è¯»ï¼Œæ•…é€šè¿‡ Wireshark è¿›è¡Œ MongoDB çš„æŠ“åŒ…è¿›è¡Œåˆ†æå’Œå­¦ä¹ </p><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><p>åœ¨æŠ“åŒ…è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç° MongoDB åœ¨3.6ä¹‹åå¼•å…¥äº†æ–°çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼Œä¸ä¹‹å‰ä¸åŒï¼Œä½†æ€»ä½“æŠ¥æ–‡è§£æé€»è¾‘æ˜¯ç›¸åŒçš„</p><p>è¯ä¸å¤šè¯´ï¼Œå…ˆä¸ŠMongoDBæ•°æ®åŒ…çš„æ­£ç¡®æ‰“å¼€æ–¹å¼</p><h2 id="é…ç½®MongoDBåè®®è§£ç å™¨"><a href="#é…ç½®MongoDBåè®®è§£ç å™¨" class="headerlink" title="é…ç½®MongoDBåè®®è§£ç å™¨"></a>é…ç½®MongoDBåè®®è§£ç å™¨</h2><ol><li><p>é…ç½®éœ€è¦è§£ç çš„ç«¯å£å·å’Œåè®®<br><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200402145752.png" alt=""><br><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200402145814.png" alt="é…ç½®ç«¯å£å’Œåè®®"></p></li><li><p>è¿‡æ»¤æ‰é™¤MongoDBå¤–çš„å…¶ä»–æŠ¥æ–‡<br><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200402145842.png" alt="é…ç½®è¿‡æ»¤è§„åˆ™"></p></li><li><p>æ‰“å¼€ä¸€ä¸ªå·²ç»è§£ç å¥½çš„æŠ¥æ–‡<br><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200402145858.png" alt="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200402145858.png"><br><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200402145926.png" alt="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200402145926.png"></p></li></ol><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾ˆç›´è§‚çš„çœ‹åˆ°æ•°æ®åŒ…ä¸­éƒ½ä¼ é€’äº†é‚£äº›æ•°æ®</p><p>å¯¹äº MongoDB çš„åè®®æ¥è¯´ï¼ŒOpCodeæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ä¸œè¥¿ï¼Œæ ¹æ®OpCodeï¼ŒMongoDBåŒºåˆ†äº†ä¸åŒç‰ˆæœ¬çš„æŠ¥æ–‡ç»“æ„ã€‚æˆ‘ä»¬åœ¨Wiresharkä¸­çœ‹åˆ°çš„æŠ¥æ–‡ç»“æ„ï¼Œéƒ½æ˜¯ç»è¿‡å®Œå…¨è§£ç åçš„æ•°æ®ã€‚</p><p>å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿæœ‰å¯¹åè®®å†…å®¹çš„ä¸€ä¸ªå¤§è‡´è¯´æ˜ï¼š<a href="https://docs.mongodb.com/manual/reference/mongodb-wire-protocol/" target="_blank" rel="noopener">å®˜æ–¹çš„åè®®è¯´æ˜</a></p><p>åœ¨æŠ¥æ–‡ä¸­æœ‰å›ºå®šçš„ä¸€äº›å­—æ®µï¼Œå¦‚ä¸‹ï¼š</p><table><thead><tr><th align="center">Field</th><th align="left">Description</th></tr></thead><tbody><tr><td align="center">messageLength</td><td align="left">The total size of the message in bytes. This total includes the 4 bytes that holds the message length.</td></tr><tr><td align="center">requestID</td><td align="left">A client or database-generated identifier that uniquely identifies this message. For the case of client-generated messages (e.g. OP_QUERY and OP_GET_MORE), it will be returned in the responseTo field of the OP_REPLY message. Clients can use the requestID and the responseTo fields to associate query responses with the originating query.</td></tr><tr><td align="center">responseTo</td><td align="left">In the case of a message from the database, this will be the requestID taken from the OP_QUERY or OP_GET_MORE messages from the client. Clients can use the requestID and the responseTo fields to associate query responses with the originating query.</td></tr><tr><td align="center">opCode</td><td align="left">Type of message. See Request Opcodes for details.</td></tr></tbody></table><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MsgHeader</span> &#123;</span></span><br><span class="line">    int32   messageLength; <span class="comment">// total message size, including this</span></span><br><span class="line">    int32   requestID;     <span class="comment">// identifier for this message</span></span><br><span class="line">    int32   responseTo;    <span class="comment">// requestID from the original request</span></span><br><span class="line">                           <span class="comment">//   (used in responses from db)</span></span><br><span class="line">    int32   opCode;        <span class="comment">// request type - see table below for details</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>messageLengthï¼šä»£è¡¨äº†MongoDBä¸€æ¬¡æ¶ˆæ¯é€šè®¯ä¸­çš„æ¶ˆæ¯æ€»é•¿åº¦ï¼Œä½ç½®åœ¨æ¶ˆæ¯å¤´éƒ¨ã€‚</p><p>requestIdï¼šä¸€èˆ¬ä¸ºè¯·æ±‚å‘èµ·æ–¹çš„æ¶ˆæ¯åŒ…IDï¼Œæ­¤IDæ˜¯è‡ªå¢é•¿çš„ï¼ŒMongoDBä¼šæ ¹æ®è¿™ä¸ªIdæ¥è¿”å›è¿™ä¸ªIDå¯¹åº”çš„æ•°æ®åŒ…</p><p>responseToï¼šä¸€èˆ¬ä¸ºMongoDBè¿”å›çš„æ¶ˆæ¯åŒ…IDï¼Œè¿™ä¸ªIDä¸ºè¯·æ±‚åŒ…çš„requestId</p><p>opCodeï¼šä»£è¡¨äº†æ•°æ®åŒ…ä¸­çš„æ¶ˆæ¯ç±»å‹ï¼Œå…·ä½“çš„OpCodeçš„å¯¹åº”å…³ç³»å¦‚ä¸‹</p><p>OpCodeç¼–å·ä¸å…¶å«ä¹‰å¯¹åº”å¦‚ä¸‹ï¼š</p><blockquote><p>NOTE:<br>Starting with MongoDB 2.6 and maxWireVersion 3, MongoDB drivers use the database commands insert, update, and delete instead of OP_INSERT, OP_UPDATE, and OP_DELETE for acknowledged writes. Most drivers continue to use opcodes for unacknowledged writes.<br>In version 4.2, MongoDB removes the deprecated internal OP_COMMAND and OP_COMMANDREPLY protocol.</p></blockquote><table><thead><tr><th align="center">Opcode Name</th><th align="center">Value</th><th align="left">Comment</th></tr></thead><tbody><tr><td align="center">OP_REPLY</td><td align="center">1</td><td align="left">Reply to a client request. responseTo is set.</td></tr><tr><td align="center">OP_UPDATE</td><td align="center">2001</td><td align="left">Update document.</td></tr><tr><td align="center">OP_INSERT</td><td align="center">2002</td><td align="left">Insert new document.</td></tr><tr><td align="center">RESERVED</td><td align="center">2003</td><td align="left">Formerly used for OP_GET_BY_OID.</td></tr><tr><td align="center">OP_QUERY</td><td align="center">2004</td><td align="left">Query a collection.</td></tr><tr><td align="center">OP_GET_MORE</td><td align="center">2005</td><td align="left">Get more data from a query. See Cursors.</td></tr><tr><td align="center">OP_DELETE</td><td align="center">2006</td><td align="left">Delete documents.</td></tr><tr><td align="center">OP_KILL_CURSORS</td><td align="center">2007</td><td align="left">Notify database that the client has finished with the cursor.</td></tr><tr><td align="center">OP_MSG</td><td align="center">2013</td><td align="left">Send a message using the format introduced in MongoDB 3.6.</td></tr></tbody></table><h2 id="å…·ä½“ç±»å‹çš„-OP-CODE-æ ¼å¼è§£æ"><a href="#å…·ä½“ç±»å‹çš„-OP-CODE-æ ¼å¼è§£æ" class="headerlink" title="å…·ä½“ç±»å‹çš„ OP_CODE æ ¼å¼è§£æ"></a>å…·ä½“ç±»å‹çš„ OP_CODE æ ¼å¼è§£æ</h2><h3 id="OP-INSERT"><a href="#OP-INSERT" class="headerlink" title="OP_INSERT"></a>OP_INSERT</h3><p>OP_INSERTæ¶ˆæ¯ç”¨äºå°†ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡æ¡£æ’å…¥åˆ°é›†åˆä¸­ã€‚OP_INSERTæ¶ˆæ¯çš„æ ¼å¼ä¸º</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    MsgHeader header;             <span class="comment">// standard message header</span></span><br><span class="line">    int32     flags;              <span class="comment">// bit vector - see below</span></span><br><span class="line">    cstring   fullCollectionName; <span class="comment">// "dbname.collectionname"</span></span><br><span class="line">    document* documents;          <span class="comment">// one or more documents to insert into the collection</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">Field</th><th align="left">Description</th></tr></thead><tbody><tr><td align="center">header</td><td align="left">æ¶ˆæ¯å¤´ï¼Œå‚ç…§ä¸Šæ–¹æ ‡å‡†æ¶ˆæ¯å¤´</td></tr><tr><td align="center">flags</td><td align="left">ä½å‘é‡ï¼Œç”¨äºæŒ‡å®šæ“ä½œæ ‡å¿—ã€‚å¦‚æœä¸º0ï¼Œåˆ™æ•°æ®åº“ä¸ä¼šå› ä¸ºæŸæ¡æ•°æ®æ’å…¥å¤±è´¥è€Œåœæ­¢æ’å…¥ã€‚1-31ä¸ºæ•°æ®åº“ä¿ç•™</td></tr><tr><td align="center">fullCollectionName</td><td align="left">å®Œæ•´çš„é›†åˆåç§°ï¼Œä¹Ÿè¢«ç§°ä¸ºå‘½åç©ºé—´ï¼Œä¸€èˆ¬æ ¼å¼ä¸º: &lt;æ•°æ®åº“.é›†åˆå&gt;</td></tr><tr><td align="center">documents</td><td align="left">ä¸€ä¸ªæˆ–å¤šä¸ªè¦æ’å…¥é›†åˆçš„æ–‡æ¡£ã€‚å¦‚æœæœ‰å¤šä¸ªï¼Œåˆ™ä¾æ¬¡å°†å®ƒä»¬ä¾æ¬¡å†™å…¥socketã€‚</td></tr></tbody></table><p>OP_INSERTæ¶ˆæ¯æ— å“åº”ã€‚</p><h3 id="OP-DELETE"><a href="#OP-DELETE" class="headerlink" title="OP_DELETE"></a>OP_DELETE</h3><p>OP_DELETEæ¶ˆæ¯ç”¨äºä»é›†åˆä¸­åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡æ¡£ã€‚OP_DELETEæ¶ˆæ¯çš„æ ¼å¼ä¸ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    MsgHeader header;             <span class="comment">// standard message header</span></span><br><span class="line">    int32     ZERO;               <span class="comment">// 0 - reserved for future use</span></span><br><span class="line">    cstring   fullCollectionName; <span class="comment">// "dbname.collectionname"</span></span><br><span class="line">    int32     flags;              <span class="comment">// bit vector - see below for details.</span></span><br><span class="line">    document  selector;           <span class="comment">// query object.  See below for details.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">Field</th><th align="left">Description</th></tr></thead><tbody><tr><td align="center">header</td><td align="left">æ¶ˆæ¯å¤´ï¼Œå‚ç…§ä¸Šæ–¹æ ‡å‡†æ¶ˆæ¯å¤´</td></tr><tr><td align="center">ZERO</td><td align="left">æ•´æ•°å€¼0ã€‚æš‚æœªä½¿ç”¨ï¼Œå®˜æ–¹ç§°ä¿ç•™ä»¥å¤‡å°†æ¥ä½¿ç”¨</td></tr><tr><td align="center">numberOfCursorIDs</td><td align="left">æ¶ˆæ¯ä¸­çš„æ¸¸æ ‡IDçš„æ•°é‡</td></tr><tr><td align="center">cursorIDs</td><td align="left">è¦åˆ é™¤çš„æ¸¸æ ‡IDçš„â€œæ•°ç»„â€ã€‚å¦‚æœæœ‰å¤šä¸ªï¼Œåˆ™ä¾æ¬¡å°†å®ƒä»¬ä¾æ¬¡å†™å…¥å¥—æ¥å­—</td></tr></tbody></table><p>å¦‚æœæ¸¸æ ‡è¢«è¯»å–ç›´åˆ°ç”¨å°½ï¼ˆç›´åˆ°OP_QUERY æˆ–OP_GET_MOREè¿”å›é›¶ä½œä¸ºæ¸¸æ ‡IDï¼‰ï¼Œå°±æ²¡æœ‰å¿…è¦ç»ˆæ­¢æ¸¸æ ‡</p><h3 id="OP-UPDATE"><a href="#OP-UPDATE" class="headerlink" title="OP_UPDATE"></a>OP_UPDATE</h3><p>OP_UPDATEæ¶ˆæ¯ç”¨äºæ›´æ–°é›†åˆä¸­çš„æ–‡æ¡£ã€‚OP_UPDATEæ¶ˆæ¯çš„æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">OP_UPDATE</span> &#123;</span></span><br><span class="line">    MsgHeader header;             <span class="comment">// standard message header</span></span><br><span class="line">    int32     ZERO;               <span class="comment">// 0 - reserved for future use</span></span><br><span class="line">    cstring   fullCollectionName; <span class="comment">// "dbname.collectionname"</span></span><br><span class="line">    int32     flags;              <span class="comment">// bit vector. see below</span></span><br><span class="line">    document  selector;           <span class="comment">// the query to select the document</span></span><br><span class="line">    document  update;             <span class="comment">// specification of the update to perform</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">Field</th><th align="left">Description</th></tr></thead><tbody><tr><td align="center">header</td><td align="left">æ¶ˆæ¯å¤´ï¼Œå‚ç…§ä¸Šæ–¹æ ‡å‡†æ¶ˆæ¯å¤´</td></tr><tr><td align="center">ZERO</td><td align="left">æ•´æ•°å€¼0ã€‚æš‚æœªä½¿ç”¨ï¼Œå®˜æ–¹ç§°ä¿ç•™ä»¥å¤‡å°†æ¥ä½¿ç”¨</td></tr><tr><td align="center">fullCollectionName</td><td align="left">å®Œæ•´çš„é›†åˆåç§°ï¼Œä¹Ÿè¢«ç§°ä¸ºå‘½åç©ºé—´ï¼Œä¸€èˆ¬æ ¼å¼ä¸º: &lt;æ•°æ®åº“.é›†åˆå&gt;</td></tr><tr><td align="center">flags</td><td align="left">ä½å‘é‡ï¼Œç”¨äºæŒ‡å®šæ“ä½œæ ‡å¿—ã€‚0ï¼šå¯¹åº”äºUpsertã€‚å¦‚æœè®¾ç½®ï¼Œåˆ™å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„æ–‡æ¡£ï¼Œæ•°æ®åº“å°†æŠŠæä¾›çš„å¯¹è±¡æ’å…¥é›†åˆä¸­ã€‚1ï¼šå¯¹åº”äºMultiUpdateã€‚å¦‚æœè®¾ç½®ï¼Œæ•°æ®åº“å°†æ›´æ–°é›†åˆä¸­çš„æ‰€æœ‰åŒ¹é…å¯¹è±¡ã€‚å¦åˆ™ï¼Œä»…æ›´æ–°ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ–‡æ¡£ã€‚2- 31ä¿ç•™ã€‚å¿…é¡»è®¾ç½®ä¸º0ã€‚</td></tr><tr><td align="center">selector</td><td align="left">BSONæ–‡æ¡£ï¼ŒæŒ‡å®šç”¨äºé€‰æ‹©è¦æ›´æ–°çš„æ–‡æ¡£çš„æŸ¥è¯¢ã€‚</td></tr><tr><td align="center">update</td><td align="left">BSONæ–‡æ¡£ï¼ŒæŒ‡å®šè¦æ‰§è¡Œçš„æ›´æ–°</td></tr></tbody></table><p>OP_UPDATEæ¶ˆæ¯æ— å“åº”ã€‚</p><h3 id="OP-QUERY"><a href="#OP-QUERY" class="headerlink" title="OP_QUERY"></a>OP_QUERY</h3><p>OP_QUERYæ¶ˆæ¯ç”¨äºåœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢é›†åˆä¸­çš„æ–‡æ¡£ã€‚OP_QUERYæ¶ˆæ¯çš„æ ¼å¼ä¸ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">OP_QUERY</span> &#123;</span></span><br><span class="line">    MsgHeader header;                 <span class="comment">// standard message header</span></span><br><span class="line">    int32     flags;                  <span class="comment">// bit vector of query options.  See below for details.</span></span><br><span class="line">    cstring   fullCollectionName ;    <span class="comment">// "dbname.collectionname"</span></span><br><span class="line">    int32     numberToSkip;           <span class="comment">// number of documents to skip</span></span><br><span class="line">    int32     numberToReturn;         <span class="comment">// number of documents to return</span></span><br><span class="line">                                      <span class="comment">//  in the first OP_REPLY batch</span></span><br><span class="line">    document  query;                  <span class="comment">// query object.  See below for details.</span></span><br><span class="line">  [ document  returnFieldsSelector; ] <span class="comment">// Optional. Selector indicating the fields</span></span><br><span class="line">                                      <span class="comment">//  to return.  See below for details.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">Field</th><th align="left">Description</th></tr></thead><tbody><tr><td align="center">header</td><td align="left">æ¶ˆæ¯å¤´ï¼Œå‚ç…§ä¸Šæ–¹æ ‡å‡†æ¶ˆæ¯å¤´</td></tr><tr><td align="center">flags</td><td align="left">ä½å‘é‡ï¼Œç”¨äºæŒ‡å®šæ“ä½œæ ‡å¿—ã€‚</td></tr><tr><td align="center">fullCollectionName</td><td align="left">å®Œæ•´çš„é›†åˆåç§°ï¼Œä¹Ÿè¢«ç§°ä¸ºå‘½åç©ºé—´ï¼Œä¸€èˆ¬æ ¼å¼ä¸º: &lt;æ•°æ®åº“.é›†åˆå&gt;</td></tr><tr><td align="center">numberToSkip</td><td align="left">è®¾ç½®è¦è·³è¿‡çš„æ–‡æ¡£æ•°-ä»ç»“æœæ•°æ®é›†ä¸­çš„ç¬¬ä¸€ä¸ªæ–‡æ¡£å¼€å§‹-è¿”å›æŸ¥è¯¢ç»“æœæ—¶ã€‚</td></tr><tr><td align="center">numberToReturn</td><td align="left">å°†ç¬¬ä¸€ä¸ªOP_REPLYæ¶ˆæ¯ä¸­çš„æ–‡æ¡£æ•°é™åˆ¶ä¸ºæŸ¥è¯¢ã€‚ä½†æ˜¯ï¼ŒcursorIDå¦‚æœç»“æœå¤šäºï¼Œæ•°æ®åº“ä»å°†å»ºç«‹æ¸¸æ ‡å¹¶å°†å…¶è¿”å›ç»™å®¢æˆ·ç«¯numberToReturnã€‚å¦‚æœå®¢æˆ·ç«¯é©±åŠ¨ç¨‹åºæä¾›äº†â€œé™åˆ¶â€åŠŸèƒ½ï¼ˆä¾‹å¦‚SQL LIMITå…³é”®å­—ï¼‰ï¼Œåˆ™ç”±å®¢æˆ·ç«¯é©±åŠ¨ç¨‹åºæ¥ç¡®ä¿å°†ä¸è¶…è¿‡æŒ‡å®šæ•°é‡çš„æ–‡æ¡£è¿”å›ç»™è°ƒç”¨åº”ç”¨ç¨‹åºã€‚å¦‚æœnumberToReturnä¸º0ï¼Œåˆ™æ•°æ®åº“å°†ä½¿ç”¨é»˜è®¤çš„è¿”å›å¤§å°ã€‚å¦‚æœæ•°å­—ä¸ºè´Ÿï¼Œåˆ™æ•°æ®åº“å°†è¿”å›è¯¥æ•°å­—å¹¶å…³é—­æ¸¸æ ‡ã€‚æ— æ³•è·å–è¯¥æŸ¥è¯¢çš„å…¶ä»–ç»“æœã€‚å¦‚æœnumberToReturnä¸ºï¼Œ 1åˆ™æœåŠ¡å™¨ä¼šå°†å…¶è§†ä¸º-1ï¼ˆè‡ªåŠ¨å…³é—­å…‰æ ‡ï¼‰ã€‚</td></tr><tr><td align="center">query</td><td align="left">ä»£è¡¨æŸ¥è¯¢çš„BSONæ–‡æ¡£ã€‚è¯¥æŸ¥è¯¢å°†åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œæ‰€æœ‰è¿™äº›å…ƒç´ éƒ½å¿…é¡»åŒ¹é…æ‰èƒ½ä½¿æ–‡æ¡£åŒ…å«åœ¨ç»“æœé›†ä¸­ã€‚å¯èƒ½çš„å› ç´ åŒ…æ‹¬ $queryï¼Œ$orderbyï¼Œ$hintï¼Œå’Œ$explainã€‚</td></tr><tr><td align="center">returnFieldsSelector</td><td align="left">å¯é€‰BSONæ–‡æ¡£ï¼Œç”¨äºé™åˆ¶è¿”å›æ–‡æ¡£ä¸­çš„å­—æ®µã€‚æ‰€è¿°returnFieldsSelectorå«æœ‰ä¸€ç§æˆ–å¤šç§å…ƒç´ ï¼Œå…¶ä¸­çš„æ¯ä¸€ä¸ªæ˜¯åº”è¿”å›å­—æ®µçš„åç§°ï¼Œä»¥åŠæ•´æ•°å€¼1ã€‚</td></tr></tbody></table><p>å¯¹äºä¸Šæ–¹flagså­—æ®µï¼Œå…·ä½“æè¿°å¦‚ä¸‹ï¼š</p><ul><li>0è¢«é¢„å®šäº†ã€‚å¿…é¡»è®¾ç½®ä¸º0ã€‚</li><li>1å¯¹åº”äºTailableCursorã€‚å¯æ‹–å°¾è¡¨ç¤ºæ£€ç´¢åˆ°æœ€åä¸€ä¸ªæ•°æ®æ—¶å…‰æ ‡æœªå…³é—­ã€‚è€Œæ˜¯ï¼Œå…‰æ ‡æ ‡è®°æœ€ç»ˆå¯¹è±¡çš„ä½ç½®ã€‚å¦‚æœæ”¶åˆ°æ›´å¤šæ•°æ®ï¼Œåˆ™å¯ä»¥ç¨åä»å…‰æ ‡æ‰€åœ¨çš„ä½ç½®ç»§ç»­ä½¿ç”¨å®ƒã€‚åƒä»»ä½•â€œæ½œåœ¨æ¸¸æ ‡â€ä¸€æ ·ï¼Œæ¸¸æ ‡å¯èƒ½ä¼šåœ¨æŸä¸ªæ—¶å€™å¤±æ•ˆï¼ˆCursorNotFoundï¼‰â€“ä¾‹å¦‚ï¼Œå¦‚æœåˆ é™¤äº†å®ƒæ‰€å¼•ç”¨çš„æœ€ç»ˆå¯¹è±¡ã€‚</li><li>2å¯¹åº”äºSlaveOk.AllowæŸ¥è¯¢å‰¯æœ¬ä»å±ã€‚é€šå¸¸ï¼Œè¿™äº›è¿”å›é”™è¯¯ï¼Œä½†åç§°ç©ºé—´â€œ localâ€é™¤å¤–ã€‚</li><li>3å¯¹åº”äºOplogReplayã€‚ä»…ä¾›å†…éƒ¨å¤åˆ¶ä½¿ç”¨-ä¸åº”è®¾ç½®é©±åŠ¨ç¨‹åºã€‚</li><li>4å¯¹åº”äºNoCursorTimeoutã€‚æœåŠ¡å™¨é€šå¸¸åœ¨é—²ç½®æ—¶é—´ï¼ˆ10åˆ†é’Ÿï¼‰åä½¿ç©ºé—²æ¸¸æ ‡è¶…æ—¶ï¼Œä»¥é˜²æ­¢è¿‡å¤šä½¿ç”¨å†…å­˜ã€‚è®¾ç½®æ­¤é€‰é¡¹å¯ä»¥é˜²æ­¢è¿™ç§æƒ…å†µã€‚</li><li>5å¯¹åº”äºAwaitDataã€‚ä¸TailableCursorä¸€èµ·ä½¿ç”¨ã€‚å¦‚æœæˆ‘ä»¬åœ¨æ•°æ®çš„æœ«å°¾ï¼Œè¯·é˜»å¡ä¸€ä¼šå„¿ï¼Œè€Œä¸è¦è¿”å›ä»»ä½•æ•°æ®ã€‚è¶…æ—¶åï¼Œæˆ‘ä»¬ç…§å¸¸è¿”å›ã€‚</li><li>6å¯¹åº”äºæ’æ°”ã€‚å‡è®¾å®¢æˆ·ç«¯å°†å®Œå…¨è¯»å–æ‰€æœ‰æŸ¥è¯¢çš„æ•°æ®ï¼Œåˆ™å°†æ•°æ®ä»¥å¤šä¸ªâ€œæ›´å¤šâ€åŒ…çš„å½¢å¼å®Œæ•´ä¼ è¾“ã€‚å½“æ‚¨æå–å¤§é‡æ•°æ®å¹¶çŸ¥é“è¦å…¨éƒ¨æå–æ—¶ï¼Œé€Ÿåº¦æ›´å¿«ã€‚æ³¨æ„ï¼šé™¤éå®¢æˆ·ç«¯å…³é—­è¿æ¥ï¼Œå¦åˆ™ä¸å…è®¸å®¢æˆ·ç«¯ä¸è¯»å–æ‰€æœ‰æ•°æ®ã€‚</li><li>7å¯¹åº”äºéƒ¨åˆ†ã€‚å¦‚æœæŸäº›åˆ†ç‰‡å‘ç”Ÿæ•…éšœï¼Œåˆ™ä»mongosè·å¾—éƒ¨åˆ†ç»“æœï¼ˆè€Œä¸æ˜¯å¼•å‘é”™è¯¯ï¼‰</li><li>8-31ä¿ç•™ã€‚å¿…é¡»è®¾ç½®ä¸º0ã€‚</li></ul><p>æ•°æ®åº“ä½¿ç”¨OP_REPLYæ¶ˆæ¯æ¥å“åº” OP_QUERYæ¶ˆæ¯ã€‚</p><h3 id="OP-GET-MORE"><a href="#OP-GET-MORE" class="headerlink" title="OP_GET_MORE"></a>OP_GET_MORE</h3><p>OP_GET_MOREæ¶ˆæ¯ç”¨äºåœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢é›†åˆä¸­çš„æ–‡æ¡£ã€‚OP_GET_MOREæ¶ˆæ¯çš„æ ¼å¼ä¸ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    MsgHeader header;             <span class="comment">// standard message header</span></span><br><span class="line">    int32     ZERO;               <span class="comment">// 0 - reserved for future use</span></span><br><span class="line">    cstring   fullCollectionName; <span class="comment">// "dbname.collectionname"</span></span><br><span class="line">    int32     numberToReturn;     <span class="comment">// number of documents to return</span></span><br><span class="line">    int64     cursorID;           <span class="comment">// cursorID from the OP_REPLY</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">Field</th><th align="left">Description</th></tr></thead><tbody><tr><td align="center">header</td><td align="left">æ¶ˆæ¯å¤´ï¼Œå‚ç…§ä¸Šæ–¹æ ‡å‡†æ¶ˆæ¯å¤´</td></tr><tr><td align="center">ZERO</td><td align="left">æ•´æ•°å€¼0ã€‚æš‚æœªä½¿ç”¨ï¼Œå®˜æ–¹ç§°ä¿ç•™ä»¥å¤‡å°†æ¥ä½¿ç”¨</td></tr><tr><td align="center">fullCollectionName</td><td align="left">å®Œæ•´çš„é›†åˆåç§°ï¼Œä¹Ÿè¢«ç§°ä¸ºå‘½åç©ºé—´ï¼Œä¸€èˆ¬æ ¼å¼ä¸º: &lt;æ•°æ®åº“.é›†åˆå&gt;</td></tr><tr><td align="center">numberToReturn</td><td align="left">å°†ç¬¬ä¸€ä¸ªOP_REPLYæ¶ˆæ¯ä¸­çš„æ–‡æ¡£æ•°é™åˆ¶ä¸ºæŸ¥è¯¢ã€‚ä½†æ˜¯ï¼ŒcursorIDå¦‚æœç»“æœå¤šäºï¼Œæ•°æ®åº“ä»å°†å»ºç«‹æ¸¸æ ‡å¹¶å°†å…¶è¿”å›ç»™å®¢æˆ·ç«¯numberToReturnã€‚å¦‚æœå®¢æˆ·ç«¯é©±åŠ¨ç¨‹åºæä¾›äº†â€œé™åˆ¶â€åŠŸèƒ½ï¼ˆä¾‹å¦‚SQL LIMITå…³é”®å­—ï¼‰ï¼Œåˆ™ç”±å®¢æˆ·ç«¯é©±åŠ¨ç¨‹åºæ¥ç¡®ä¿å°†ä¸è¶…è¿‡æŒ‡å®šæ•°é‡çš„æ–‡æ¡£è¿”å›ç»™è°ƒç”¨åº”ç”¨ç¨‹åºã€‚å¦‚æœnumberToReturnä¸º0ï¼Œåˆ™æ•°æ®åº“å°†ä½¿ç”¨é»˜è®¤çš„è¿”å›å¤§å°ã€‚</td></tr><tr><td align="center">cursorID</td><td align="left">OP_REPLYä¸­çš„å…‰æ ‡æ ‡è¯†ç¬¦ã€‚è¿™å¿…é¡»æ˜¯æ¥è‡ªæ•°æ®åº“çš„å€¼ã€‚</td></tr></tbody></table><p>æ•°æ®åº“å°†ä»¥OP_REPLYæ¶ˆæ¯å“åº” OP_GET_MOREæ¶ˆæ¯ã€‚</p><h3 id="OP-KILL-CURSORS"><a href="#OP-KILL-CURSORS" class="headerlink" title="OP_KILL_CURSORS"></a>OP_KILL_CURSORS</h3><p>OP_KILL_CURSORSæ¶ˆæ¯ç”¨äºå…³é—­æ•°æ®åº“ä¸­çš„æ´»åŠ¨æ¸¸æ ‡ã€‚è¿™æ˜¯ç¡®ä¿æŸ¥è¯¢ç»“æŸæ—¶å›æ”¶æ•°æ®åº“èµ„æºæ‰€å¿…éœ€çš„ã€‚OP_KILL_CURSORSæ¶ˆæ¯çš„æ ¼å¼ä¸ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    MsgHeader header;            <span class="comment">// standard message header</span></span><br><span class="line">    int32     ZERO;              <span class="comment">// 0 - reserved for future use</span></span><br><span class="line">    int32     numberOfCursorIDs; <span class="comment">// number of cursorIDs in message</span></span><br><span class="line">    int64*    cursorIDs;         <span class="comment">// sequence of cursorIDs to close</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">Field</th><th align="left">Description</th></tr></thead><tbody><tr><td align="center">header</td><td align="left">æ¶ˆæ¯å¤´ï¼Œå‚ç…§ä¸Šæ–¹æ ‡å‡†æ¶ˆæ¯å¤´</td></tr><tr><td align="center">ZERO</td><td align="left">æ•´æ•°å€¼0ã€‚æš‚æœªä½¿ç”¨ï¼Œå®˜æ–¹ç§°ä¿ç•™ä»¥å¤‡å°†æ¥ä½¿ç”¨</td></tr><tr><td align="center">numberOfCursorIDs</td><td align="left">æ¶ˆæ¯ä¸­çš„æ¸¸æ ‡IDçš„æ•°é‡ã€‚</td></tr><tr><td align="center">cursorIDs</td><td align="left">è¦å…³é—­çš„æ¸¸æ ‡IDçš„â€œæ•°ç»„â€ã€‚å¦‚æœæœ‰å¤šä¸ªï¼Œåˆ™ä¾æ¬¡å°†å®ƒä»¬ä¾æ¬¡å†™å…¥socketã€‚</td></tr><tr><td align="center">å¦‚æœæ¸¸æ ‡è¢«è¯»å–ç›´åˆ°ç”¨å°½ï¼ˆç›´åˆ°OP_QUERY æˆ–OP_GET_MOREè¿”å›é›¶ä½œä¸ºæ¸¸æ ‡IDï¼‰ï¼Œå°±æ²¡æœ‰å¿…è¦ç»ˆæ­¢æ¸¸æ ‡ã€‚</td><td align="left"></td></tr></tbody></table><h3 id="OP-MSG"><a href="#OP-MSG" class="headerlink" title="OP_MSG"></a>OP_MSG</h3><blockquote><p>MongoDBç‰ˆæœ¬ä¸­çš„æ–°åŠŸèƒ½ï¼š 3.6</p></blockquote><p>OP_MSGæ˜¯ä¸€ç§å¯æ‰©å±•çš„æ¶ˆæ¯æ ¼å¼ï¼Œæ—¨åœ¨åŒ…å«å…¶ä»–æ“ä½œç çš„åŠŸèƒ½ã€‚OP_MSGæ¶ˆæ¯çš„æ ¼å¼ä¸ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">OP_MSG &#123;</span><br><span class="line">    MsgHeader header;          <span class="comment">// standard message header</span></span><br><span class="line">    uint32 flagBits;           <span class="comment">// message flags</span></span><br><span class="line">    Sections[] sections;       <span class="comment">// data sections</span></span><br><span class="line">    optional&lt;uint32&gt; checksum; <span class="comment">// optional CRC-32C checksum</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">Field</th><th align="left">Description</th></tr></thead><tbody><tr><td align="center">header</td><td align="left">æ¶ˆæ¯å¤´ï¼Œå‚ç…§ä¸Šæ–¹æ ‡å‡†æ¶ˆæ¯å¤´</td></tr><tr><td align="center">flagBits</td><td align="left">åŒ…å«æ¶ˆæ¯æ ‡å¿—çš„æ•´æ•°ä½æ©ç </td></tr><tr><td align="center">sections</td><td align="left">æ¶ˆæ¯ä¸»ä½“éƒ¨ä¸­ï¼Œå¦‚æ‰€æè¿°çš„ç« èŠ‚</td></tr><tr><td align="center">checksum</td><td align="left">å¯é€‰çš„CRC-32Cæ ¡éªŒå’Œï¼Œå¦‚ Checksumä¸­æ‰€è¿°</td></tr></tbody></table><p>å…·ä½“ä¿¡æ¯å‚ç…§ä¸‹æ–¹æè¿°ï¼š</p><h4 id="flagBits"><a href="#flagBits" class="headerlink" title="flagBits"></a>flagBits</h4><p>è¯¥flagBitsæ•´æ•°æ˜¯ç¼–ç ä¿®æ”¹çš„æ ¼å¼å’Œè¡Œä¸ºçš„æ ‡å¿—ä½æ©ç OP_MSGã€‚</p><p>å‰16ä½ï¼ˆ0-15ï¼‰æ˜¯å¿…éœ€çš„ï¼Œ å¦‚æœè®¾ç½®äº†ä¸€ä¸ªä½ç½®çš„bitï¼Œåˆ™è§£æå™¨åŠ¡å¿…å‡ºé”™ã€‚</p><p>æœ€å16ä½ï¼ˆ16-31ï¼‰æ˜¯å¯é€‰çš„ï¼Œè§£æå™¨åŠ¡å¿…å¿½ç•¥ä»»ä½•æœªçŸ¥çš„è¢«è®¾ç½®çš„bitã€‚ä»£ç†å’Œå…¶ä»–æ¶ˆæ¯è½¬å‘å™¨å¿…é¡»åœ¨è½¬å‘æ¶ˆæ¯ä¹‹å‰æ¸…é™¤æ‰€æœ‰æœªçŸ¥çš„å¯é€‰ä½ã€‚</p><table><thead><tr><th align="center">Bit</th><th align="center">Name</th><th align="center">Request</th><th align="center">Response</th><th align="left">Description</th></tr></thead><tbody><tr><td align="center">0</td><td align="center">checksumPresent</td><td align="center">âœ“</td><td align="center">âœ“</td><td align="left">è¯¥æ¶ˆæ¯ä»¥4ä¸ªå­—èŠ‚ç»“å°¾ï¼Œå…¶ä¸­åŒ…å«CRC-32C [1] æ ¡éªŒå’Œã€‚</td></tr><tr><td align="center">1</td><td align="center">moreToCome</td><td align="center">âœ“</td><td align="center">âœ“</td><td align="left">å¦ä¸€æ¡æ¶ˆæ¯å°†è·Ÿéšæ­¤æ¶ˆæ¯ï¼Œè€Œæ— éœ€æ¥æ”¶è€…é‡‡å–è¿›ä¸€æ­¥æªæ–½ã€‚æ¥æ”¶å™¨å¿…é¡»ä¸å‘é€å¦ä¸€æ¶ˆæ¯ï¼Œç›´åˆ°æ¥æ”¶åˆ°ä¸€ä¸ªå…·æœ‰moreToComeè®¾ç½®ä¸º0ä½œä¸ºå‘é€å¯èƒ½é˜»å¡ï¼Œå¼•èµ·æ­»é”ã€‚moreToCome è®¾ç½®äº†è¯¥ä½çš„è¯·æ±‚å°†ä¸ä¼šæ”¶åˆ°ç­”å¤ã€‚ç­”å¤å°†ä»…åœ¨è®¾ç½®äº†è¯¥exhaustAllowedä½çš„æƒ…å†µä¸‹å“åº”æ­¤è¯·æ±‚ã€‚</td></tr><tr><td align="center">16</td><td align="center">exhaustAllowed</td><td align="center">âœ“</td><td align="center">-</td><td align="left">å®¢æˆ·ç«¯å·²å‡†å¤‡å¥½ä½¿ç”¨è¯¥moreToComeä½å¯¹è¯¥è¯·æ±‚è¿›è¡Œå¤šæ¬¡ç­”å¤ã€‚moreToComeé™¤éè¯·æ±‚è®¾ç½®äº†è¯¥ä½ï¼Œå¦åˆ™æœåŠ¡å™¨å°†æ°¸è¿œä¸ä¼šäº§ç”Ÿè®¾ç½®äº†ä½çš„å›å¤ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ä»…åœ¨è¯·æ±‚è€…çš„ç½‘ç»œå±‚å·²å‡†å¤‡å¥½å¤šä¸ªç­”å¤æ—¶æ‰å‘é€å®ƒä»¬ã€‚</td></tr></tbody></table><p>MongoDB 3.6ä¼šå¿½ç•¥æ­¤æ ‡å¿—ï¼Œå¹¶å°†ä»¥ä¸€æ¡æ¶ˆæ¯è¿›è¡Œå“åº”</p><h4 id="Sections"><a href="#Sections" class="headerlink" title="Sections"></a>Sections</h4><p>ä¸€æ¡OP_MSGæ¶ˆæ¯åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªéƒ¨åˆ†ã€‚æ¯ä¸ªéƒ¨åˆ†éƒ½ä»¥ä¸€ä¸ªkindæŒ‡ç¤ºå…¶ç±»å‹çš„å­—èŠ‚å¼€å¤´ã€‚kind å­—èŠ‚ä¹‹åçš„æ‰€æœ‰å†…å®¹å‡æ„æˆè¯¥èŠ‚çš„æœ‰æ•ˆè´Ÿè½½ã€‚</p><p>å¯ç”¨çš„éƒ¨åˆ†å¦‚ä¸‹ï¼š</p><ul><li>Kind 0: Body</li></ul><p>æ­£æ–‡éƒ¨åˆ†è¢«ç¼–ç ä¸ºå•ä¸ª BSONå¯¹è±¡ã€‚BSONå¯¹è±¡ä¸­çš„å¤§å°ä¹Ÿç”¨ä½œéƒ¨åˆ†çš„å¤§å°ã€‚æ­¤éƒ¨åˆ†ç±»å‹æ˜¯æ ‡å‡†å‘½ä»¤è¯·æ±‚å’Œç­”å¤æ­£æ–‡ã€‚</p><p>æ‰€æœ‰é¡¶çº§å­—æ®µéƒ½å¿…é¡»å…·æœ‰å”¯ä¸€çš„åç§°ã€‚</p><ul><li>Kind 1: Document Sequence</li></ul><table><thead><tr><th align="center">Type</th><th>Description</th></tr></thead><tbody><tr><td align="center">int32</td><td>sectionçš„å¤§å°.</td></tr><tr><td align="center">C String</td><td>æ–‡æ¡£åºåˆ—æ ‡è¯†ç¬¦ã€‚åœ¨æ‰€æœ‰å½“å‰å‘½ä»¤ä¸­ï¼Œæ­¤å­—æ®µæ˜¯ä»body sectionæ›¿æ¢çš„ï¼ˆå¯èƒ½æ˜¯åµŒå¥—çš„ï¼‰å­—æ®µã€‚ä½†æ˜¯ä¸å¾—ä¹Ÿå­˜åœ¨äºä¸»ä½“éƒ¨åˆ†ã€‚</td></tr><tr><td align="center">Zero or more BSON objects</td><td>é›¶ä¸ªæˆ–å¤šä¸ªBSONå¯¹è±¡ã€‚å¯¹è±¡ä¸ä½¿ç”¨åˆ†éš”ç¬¦æ¥èƒŒå¯¹èƒŒæ’åºã€‚</td></tr></tbody></table><p>å¯¹äºZero or more BSON objectsæ¥è¯´ï¼Œæ¯ä¸ªå¯¹è±¡ä»…é™äºmaxBSONObjectSizeæœåŠ¡å™¨çš„ã€‚æ‰€æœ‰å¯¹è±¡çš„ç»„åˆä¸é™äº maxBSONObjSizeã€‚<br>ä¸€æ—¦sizeæ¶ˆè€—å®Œå­—èŠ‚ï¼Œæ–‡æ¡£åºåˆ—å°±ç»“æŸã€‚<br>è½¬æ¢ä¸ºè¯­è¨€çº§å¯¹è±¡æ—¶ï¼Œè§£æå™¨å¯ä»¥é€‰æ‹©å°†è¿™äº›å¯¹è±¡ä½œä¸ºæ•°ç»„åˆå¹¶åˆ°åºåˆ—æ ‡è¯†ç¬¦æŒ‡å®šçš„è·¯å¾„å¤„çš„æ•°ç»„ä¸­ã€‚</p><h4 id="Checksum"><a href="#Checksum" class="headerlink" title="Checksum"></a>Checksum</h4><p>æ¯æ¡æ¶ˆæ¯å¯ä»¥ä»¥CRC-32C [1]æ ¡éªŒå’Œç»“å°¾ï¼Œè¯¥æ ¡éªŒå’Œè¦†ç›–æ¶ˆæ¯ä¸­æ‰€æœ‰å­—èŠ‚ï¼Œæ ¡éªŒå’Œæœ¬èº«é™¤å¤–</p><p>ä»MongoDB 4.2å¼€å§‹ï¼š</p><ul><li>mongodå¦‚æœä¸ä½¿ç”¨TLS / SSLè¿æ¥mongosï¼Œåˆ™å®ä¾‹ï¼Œå®ä¾‹å’Œ mongoå¤–å£³ç¨‹åºå®ä¾‹å°†ä¸æ ¡éªŒå’Œäº¤æ¢æ¶ˆæ¯ã€‚</li><li>mongodå¦‚æœä½¿ç”¨TLS / SSLè¿æ¥mongosï¼Œåˆ™å®ä¾‹ï¼Œå®ä¾‹å’Œ mongoå¤–å£³ç¨‹åºå®ä¾‹å°†è·³è¿‡æ ¡éªŒå’Œã€‚</li></ul><p>å¦‚æœé©±åŠ¨ç¨‹åºå’Œè¾ƒæ—§çš„äºŒè¿›åˆ¶æ–‡ä»¶å¸¦æœ‰å¸¦æœ‰æ ¡éªŒå’Œçš„æ¶ˆæ¯ï¼Œåˆ™å®ƒä»¬å°†å¿½ç•¥æ ¡éªŒå’Œã€‚</p><p>checksumPresentæ ‡å¿—ä½æŒ‡ç¤ºå­˜åœ¨æ ¡éªŒå’Œã€‚</p><h3 id="OP-REPLY"><a href="#OP-REPLY" class="headerlink" title="OP_REPLY"></a>OP_REPLY</h3><p>è¯¥OP_REPLYæ¶ˆæ¯ç”±æ•°æ®åº“å‘é€ï¼Œä»¥å“åº” OP_QUERYæˆ–OP_GET_MOREæ¶ˆæ¯ã€‚OP_REPLYæ¶ˆæ¯çš„æ ¼å¼ä¸ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    MsgHeader header;         <span class="comment">// standard message header</span></span><br><span class="line">    int32     responseFlags;  <span class="comment">// bit vector - see details below</span></span><br><span class="line">    int64     cursorID;       <span class="comment">// cursor id if client needs to do get more's</span></span><br><span class="line">    int32     startingFrom;   <span class="comment">// where in the cursor this reply is starting</span></span><br><span class="line">    int32     numberReturned; <span class="comment">// number of documents in the reply</span></span><br><span class="line">    document* documents;      <span class="comment">// documents</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">Field</th><th>Description</th></tr></thead><tbody><tr><td align="center">header</td><td>æ¶ˆæ¯å¤´ï¼Œå‚ç…§ä¸Šæ–¹æ ‡å‡†æ¶ˆæ¯å¤´</td></tr><tr><td align="center">responseFlags</td><td>æŒ‡å®šæ ‡å¿—çš„bitå‘é‡</td></tr><tr><td align="center">cursorID</td><td>è¯¥cursorID ä¸º OP_REPLYçš„ä¸€éƒ¨åˆ†ã€‚å¦‚æœæŸ¥è¯¢çš„ç»“æœé›†é€‚åˆä¸€ä¸ªOP_REPLYæ¶ˆæ¯ï¼Œ cursorIDåˆ™å°†ä¸º0ã€‚cursorIDå¿…é¡»åœ¨ç”¨äºè·å–æ›´å¤šæ•°æ®çš„ä»»ä½• OP_GET_MOREæ¶ˆæ¯ä¸­ä½¿ç”¨æ­¤å€¼ï¼Œå¹¶ä¸”å½“ä¸å†éœ€è¦é€šè¿‡OP_KILL_CURSORS æ¶ˆæ¯å°†å…¶å…³é—­æ—¶ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¿…é¡»å°†å…¶å…³é—­ã€‚</td></tr><tr><td align="center">startingFrom</td><td>æ¸¸æ ‡å¼€å§‹ä½ç½®</td></tr><tr><td align="center">numberReturned</td><td>è¿”å›çš„æ–‡æ¡£æ•°é‡.</td></tr><tr><td align="center">documents</td><td>è¿”å›çš„æ–‡æ¡£</td></tr></tbody></table><p>å¯¹äºresponseFlagsçš„è¯´æ˜</p><ul><li>0å¯¹åº”äºCursorNotFoundã€‚åœ¨getMoreè°ƒç”¨æ—¶è®¾ç½®ï¼Œä½†å…‰æ ‡IDåœ¨æœåŠ¡å™¨ä¸Šæ— æ•ˆã€‚è¿”å›ç»“æœä¸ºé›¶ã€‚</li><li>1å¯¹åº”äºQueryFailureã€‚æŸ¥è¯¢å¤±è´¥æ—¶è®¾ç½®ã€‚ç»“æœç”±ä¸€ä¸ªæ–‡æ¡£ç»„æˆï¼Œå…¶ä¸­åŒ…å«æè¿°å¤±è´¥çš„â€œ $ errâ€å­—æ®µã€‚</li><li>2å¯¹åº”äºShardConfigStaleã€‚é©±åŠ¨åº”å¿½ç•¥è¿™ä¸€ç‚¹ã€‚åªæœ‰mongoså°†çœ‹åˆ°æ­¤è®¾ç½®ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒéœ€è¦ä»æœåŠ¡å™¨æ›´æ–°é…ç½®ã€‚</li><li>3å¯¹åº”äºAwaitCapableã€‚å½“æœåŠ¡å™¨æ”¯æŒAwaitDataæŸ¥è¯¢é€‰é¡¹æ—¶è®¾ç½®ã€‚å¦‚æœä¸æ˜¯è¿™æ ·ï¼Œåˆ™å®¢æˆ·ç«¯åº”è¯¥åœ¨Tailableæ¸¸æ ‡çš„getMoreä¹‹é—´ç¡ä¸€ä¼šå„¿ã€‚Mongod 1.6ç‰ˆæ”¯æŒAwaitDataï¼Œå› æ­¤å§‹ç»ˆè®¾ç½®AwaitCapableã€‚</li><li>4-31ä¿ç•™ã€‚å¿½è§†ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
            <tag> TCP </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
